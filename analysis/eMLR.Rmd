---
title: "Data base"
author: "Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

```{r library, message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(patchwork)
```


```{r ggplot_theme, include = FALSE}
theme_set(theme_bw())
```

# Open required data sets

## GLODAP

```{r reopen_GLODAP}

GLODAP <- read_csv(here::here("data/GLODAPv2_2020/_summarized_data_files",
                              "GLODAPv2.2020_clean.csv"))

```

## GLODAP Cant climatology

```{r open_GLODAP_Cant_climatology}

Cant_clim <- read_csv(here::here("data/GLODAPv2_2016b_MappedClimatologies/_summarized_files",
                                 "Cant.csv"))
```

```{r adjust_lon_scales}

Cant_clim <- Cant_clim %>% 
  mutate(lon = if_else(lon>180, lon - 360, lon))

```

## Atmospheric pCO2

```{r open_atm_pCO2}

co2_atm <- read_csv(here::here("data/pCO2_atmosphere/_summarized_data_files",
                               "co2_atm.csv"))

```


# C*

## stoichiometric ratios

```{r set_stoichiometric_ratios}

rCP <- 117
rNP <- 16

```

The stoichiometric nutrient ratios for the production and mineralization of organic matter were set to:

- C/P: `r rCP`
- N/P: `r rNP`

## Calculation

```{r calculate_C_star}

GLODAP <- GLODAP %>% 
  mutate(rCP_phosphate = - rCP * phosphate,
         talk_05 = - 0.5 * talk,
         rNP_phosphate_05 = - 0.5 * rNP * phosphate,
         C_star = tco2 + rCP_phosphate + talk_05 + rNP_phosphate_05)

```


# Reference year adjustment

The scaling factor Cant_apriori at a given location and depth was estimated for each reference year from XXX.
Note that eq. 6 in Clement and Gruber (2018) misses pCO2 pre-industrial in the denominator.

## Merge data sets

### Cant

```{r merge_Cstar_Cant}

Cant_clim <- Cant_clim %>% 
  drop_na()

GLODAP_Cant_full <- full_join(GLODAP, Cant_clim)

```

```{r interpolate_Cant_to_observations}

GLODAP_Cant_observations_available <- GLODAP_Cant_full %>% 
  group_by(lat, lon) %>% 
  mutate(n_GLODAP = sum(!is.na(C_star))) %>% 
  ungroup() %>% 
  filter(n_GLODAP > 0) %>% 
  select(-n_GLODAP)

rm(GLODAP_Cant_full)

GLODAP_Cant_observations_available <- GLODAP_Cant_observations_available %>% 
  group_by(lat, lon) %>% 
  arrange(depth) %>% 
  mutate(Cant_int = approxfun(depth, Cant, rule = 2)(depth)) %>% 
  ungroup()

ggplot()+
  geom_point(data = GLODAP_Cant_observations_available %>% 
              filter(lat == 48.5, lon == 165.5),
            aes(Cant_int, depth, col="interpolated"))+
  geom_path(data = GLODAP_Cant_observations_available %>% 
              filter(lat == 48.5, lon == 165.5, !is.na(Cant)) %>% 
              arrange(depth),
            aes(Cant, depth, col="mapped"))+
  geom_point(data = GLODAP_Cant_observations_available %>% 
              filter(lat == 48.5, lon == 165.5, !is.na(Cant)) %>% 
              arrange(depth),
            aes(Cant, depth, col="mapped"))+
  scale_y_reverse()

GLODAP <- GLODAP_Cant_observations_available %>% 
  filter(!is.na(C_star)) %>% 
  mutate(Cant = Cant_int) %>% 
  select(-Cant_int)

rm(GLODAP_Cant_observations_available, Cant_clim)

```

### Atm pCO2


```{r merge_Cstar_pCO2}

GLODAP <- full_join(GLODAP, co2_atm)
#rm(co2_atm)

```


## Perform adjustment

```{r adjust_reference_year}

GLODAP <- GLODAP %>% 
  group_by(era) %>% 
  mutate(tref = median(year)) %>% 
  ungroup()

tref <- GLODAP %>% 
  filter(!is.na(era)) %>% 
  group_by(era) %>% 
  summarise(year = median(year)) %>% 
  ungroup()

co2_atm_tref <- right_join(co2_atm, tref) %>% 
  select(-year) %>% 
  rename(pCO2_tref = pCO2)

GLODAP <- full_join(GLODAP, co2_atm_tref)

GLODAP <- GLODAP %>% 
  mutate(C_star_tref_delta = 
           ( (pCO2 - pCO2_tref) / (pCO2_tref - 280) ) * Cant,
         C_star_tref = C_star - C_star_tref_delta)

GLODAP %>% 
  ggplot(aes(C_star_tref_delta))+
  geom_histogram()

```



# Selected section plots

```{r select_cruises}

cruises_meridional <- c("1041")

# cruises_meridional <- c("1041","1042", "260",
#                         "2011", "393", "1031", "394", "395",
#                         "1088", "983")

# cruises_zonal <- c()

GLODAP_cruise <- GLODAP %>% 
  filter(cruise %in% cruises_meridional)

```

```{r meridional_sections}

mapWorld <- borders("world", colour="gray60", fill="gray60")

#map <- 
GLODAP_cruise %>%
  ggplot(aes(lon, lat))+
  mapWorld+
  geom_point(aes(col=date))+
  geom_path()+
  coord_quickmap(expand = FALSE)+
  scale_color_viridis_c(trans = "date")

lat_section <- 
GLODAP_cruise %>%
  ggplot(aes(lat, depth))+
  scale_y_reverse()+
  scale_color_viridis_c()

#lat_tco2 <- 
lat_section+
  geom_point(aes(col=tco2))

#lat_talk <- 
lat_section+
  geom_point(aes(col=talk))

#lat_phosphate <- 
lat_section+
  geom_point(aes(col=phosphate))

#lat_rCP_phosphate <- 
lat_section+
  geom_point(aes(col=rCP_phosphate))

#lat_talk_05 <- 
lat_section+
  geom_point(aes(col=talk_05))

#lat_rNP_phosphate_05 <- 
lat_section+
  geom_point(aes(col=rNP_phosphate_05))

#lat_C_star <- 
lat_section+
  geom_point(aes(col=C_star))

lat_section+
  geom_point(aes(col=Cant))

#lat_C_star_tref <- 
lat_section+
  geom_point(aes(col=C_star_tref_delta))


# map / lat_tco2 / lat_talk / lat_phosphate / lat_rCP_phosphate /lat_talk_05 /lat_rNP_phosphate_05 / lat_C_star / lat_C_star_tref
# 
# rm(map, lat_tco2, lat_talk, lat_phosphate, lat_C_star, lat_C_star_tref)

```




# MLR fitting

```{r predictor_variables, eval=FALSE}

temperature
salinity
phosphate
silicate
phosphate_star = phosphate + (oxygen / 170) - 1.95
oxygen
aou


```

```{r estimate_MLR_models, eval=FALSE}

basins <- c("Atlantic", "Indo_Pacific")
slabs <- c("")

for (i_basin in basins) {
  for (i_slab in slabs) {
    
    
  }
  
}

```


