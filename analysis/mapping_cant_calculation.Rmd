---
title: "Mapping Cant"
author: "Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r library, message=FALSE, warning=FALSE}
library(tidyverse)
library(metR)
```

```{r read_parameters, include = FALSE}

parameters <-
  read_rds(here::here("data",
                       "parameters.rds"))
```

```{r read_mask_files}

basinmask <-
  read_csv(
    here::here(
      "data/World_Ocean_Atlas_2018/_summarized_files",
      "basin_mask_WOA18.csv"
    )
  )

basinmask_AIP <-
  read_csv(
    here::here(
      "data/World_Ocean_Atlas_2018/_summarized_files",
      "basin_mask_WOA18_AIP.csv"
    )
  )

landmask <-
  read_csv(
    here::here(
      "data/World_Ocean_Atlas_2018/_summarized_files",
      "land_mask_WOA18.csv"
    )
  )

```

```{r read_parameters_functions, include = FALSE}
source(here::here("code", "plotting_functions.R"))
```

```{r ggplot_theme, include = FALSE}
theme_set(theme_bw())
```

# Predictor fields

Currently, we use combined predictor fields:

- WOA18: S, T, and derived variables
- GLODAP16: Oxygen, PO4, NO3, Silicate, and derived variables

```{r read_predictor_file}

predictors <- 
    read_csv(here::here("data/mapping/predictor_fields",
                         "W18_st_G16_opsn.csv"))

```


# Load MLR models

```{r load_eMLR_models}

lm_all_wide <-
  read_csv(here::here("data/eMLR",
                       "lm_all_wide.csv"))
```

# Merge MLRs + climatologies

```{r merge_model_coeff_predictor_climatology}

lm_all_wide <- lm_all_wide %>% 
  mutate(model = str_remove(model, "Cstar ~ "))
         
Cant <- full_join(predictors, lm_all_wide)

rm(predictors, lm_all_wide)

```

# Map Cant

## Apply MLRs to predictor

```{r calculate_Cant}

Cant <- Cant %>% 
  mutate(Cant = `delta_coeff_(Intercept)` +
           delta_coeff_aou * aou +
           delta_coeff_oxygen * oxygen +
           delta_coeff_phosphate * phosphate +
           delta_coeff_phosphate_star * phosphate_star +
           delta_coeff_silicate * silicate +
           delta_coeff_sal * sal + 
           delta_coeff_tem * tem)

```

```{r calculate_predictor_contributions_to_Cant}

Cant <- Cant %>% 
  mutate(Cant_intercept = `delta_coeff_(Intercept)`,
         Cant_aou = delta_coeff_aou * aou,
         Cant_oxygen = delta_coeff_oxygen * oxygen,
         Cant_phosphate = delta_coeff_phosphate * phosphate,
         Cant_phosphate_star = delta_coeff_phosphate_star * phosphate_star,
         Cant_silicate = delta_coeff_silicate * silicate,
         Cant_sal = delta_coeff_sal * sal,
         Cant_tem = delta_coeff_tem * tem,
         Cant_sum = Cant_intercept +
           Cant_aou +
           Cant_oxygen +
           Cant_phosphate +
           Cant_phosphate_star +
           Cant_silicate + 
           Cant_sal +
           Cant_tem)

```



## Mean Cant fields

Mean and sd are calculated for Cant in each grid cell (XYZ), basin and era combination. Calculations are performed for all Cant values vs positive values only. This averaging step summarizes the information derived from ten best fitting MLRs. 

```{r Calculate_Cant_mean}

Cant_predictor_average <- Cant %>%
  mutate(Cant_pos = if_else(Cant < 0, 0, Cant)) %>%
  group_by(lon, lat, depth, eras, basin) %>%
  summarise(Cant_intercept = mean(Cant_intercept, na.rm = TRUE),
            Cant_aou = mean(Cant_aou, na.rm = TRUE),
            Cant_oxygen = mean(Cant_oxygen, na.rm = TRUE),
            Cant_phosphate = mean(Cant_phosphate, na.rm = TRUE),
            Cant_phosphate_star = mean(Cant_phosphate_star, na.rm = TRUE),
            Cant_silicate = mean(Cant_silicate, na.rm = TRUE),
            Cant_tem = mean(Cant_tem, na.rm = TRUE),
            Cant_sal = mean(Cant_sal, na.rm = TRUE),
            Cant_sum = mean(Cant_sum, na.rm = TRUE),
            gamma_mean = mean(gamma, na.rm = TRUE)
            ) %>%
  ungroup()

Cant_predictor_average_Atl <- Cant_predictor_average %>% 
  filter(basin == "Atlantic") %>% 
  mutate(gamma_slab = cut(gamma_mean, parameters$slabs_Atl))

Cant_predictor_average_Ind_Pac <- Cant_predictor_average %>% 
  filter(basin == "Indo-Pacific") %>% 
  mutate(gamma_slab = cut(gamma_mean, parameters$slabs_Ind_Pac))

Cant_predictor_average <- bind_rows(Cant_predictor_average_Atl, Cant_predictor_average_Ind_Pac)

rm(Cant_predictor_average_Atl, Cant_predictor_average_Ind_Pac)

# Cant <- Cant %>%
#   select(lon, lat, depth, eras, basin, Cant, gamma, model)

Cant_average <- Cant %>%
  mutate(Cant_pos = if_else(Cant < 0, 0, Cant)) %>%
  group_by(lon, lat, depth, eras, basin) %>%
  summarise(Cant_mean = mean(Cant, na.rm = TRUE),
            Cant_sd = sd(Cant, na.rm = TRUE),
            Cant_pos_mean = mean(Cant_pos, na.rm = TRUE),
            Cant_pos_sd = sd(Cant_pos, na.rm = TRUE),
            gamma_mean = mean(gamma, na.rm = TRUE),
            gamma_sd = sd(gamma, na.rm = TRUE)) %>%
  ungroup()

Cant_average_Atl <- Cant_average %>% 
  filter(basin == "Atlantic") %>% 
  mutate(gamma_slab = cut(gamma_mean, parameters$slabs_Atl))

Cant_average_Ind_Pac <- Cant_average %>% 
  filter(basin == "Indo-Pacific") %>% 
  mutate(gamma_slab = cut(gamma_mean, parameters$slabs_Ind_Pac))

Cant_average <- bind_rows(Cant_average_Atl, Cant_average_Ind_Pac)

rm(Cant_average_Atl, Cant_average_Ind_Pac)

```

## Mean Cant sections

For each basin and era combination, the zonal mean Cant is calculated, again for all vs positive only values. Likewise, sd is calculated for the averaging of the mean basin fields.

```{r Calculate_Cant_mean_sections}

Cant_average <- full_join(Cant_average,
                                basinmask_AIP %>% select(-basin))

Cant_average_zonal <- Cant_average %>%
  group_by(lat, depth, eras, basin, basin_AIP) %>%
  summarise(across(
    c(
      "Cant_mean",
      "Cant_pos_mean",
      "Cant_sd",
      "Cant_pos_sd",
      "gamma_mean",
      "gamma_sd"
    ),
    list(mean = ~ mean(.x, na.rm = TRUE),
         sd = ~ sd(.x, na.rm = TRUE))
  )) %>%
  ungroup()


# Cant_average_zonal <- Cant_average %>% 
#   group_by(lat, depth, eras, basin) %>% 
#   summarise(Cant_mean_sd = sd(Cant_mean, na.rm = TRUE),
#             Cant_mean = mean(Cant_mean, na.rm = TRUE),
#             Cant_sd_mean = mean(Cant_sd, na.rm = TRUE),
#             Cant_pos_mean_sd = sd(Cant_pos_mean, na.rm = TRUE),
#             Cant_pos_mean = mean(Cant_pos_mean, na.rm = TRUE),
#             Cant_pos_sd_mean = mean(Cant_pos_sd, na.rm = TRUE),
#             gamma_mean = mean(gamma_mean)) %>% 
#   ungroup()


Cant_average_zonal_Atl <- Cant_average_zonal %>% 
  filter(basin == "Atlantic") %>% 
  mutate(gamma_slab = cut(gamma_mean_mean, parameters$slabs_Atl))

Cant_average_zonal_Ind_Pac <- Cant_average_zonal %>% 
  filter(basin == "Indo-Pacific") %>% 
  mutate(gamma_slab = cut(gamma_mean_mean, parameters$slabs_Ind_Pac))

Cant_average_zonal <- bind_rows(Cant_average_zonal_Atl, Cant_average_zonal_Ind_Pac)

rm(Cant_average_zonal_Atl, Cant_average_zonal_Ind_Pac)

```

## Mean Cant sections by coefficient

For each basin and era combination, the zonal mean Cant is calculated by model coefficient.

```{r Calculate_Cant_predictor_mean_sections}

Cant_predictor_average <- full_join(Cant_predictor_average,
                                basinmask_AIP %>% select(-basin))

Cant_predictor_average_zonal <- Cant_predictor_average %>%
  group_by(lat, depth, eras, basin, basin_AIP) %>%
  summarise(across(
    Cant_intercept:gamma_mean,
    list(mean = ~ mean(.x, na.rm = TRUE))
  )) %>%
  ungroup()


# Cant_average_zonal <- Cant_average %>% 
#   group_by(lat, depth, eras, basin) %>% 
#   summarise(Cant_mean_sd = sd(Cant_mean, na.rm = TRUE),
#             Cant_mean = mean(Cant_mean, na.rm = TRUE),
#             Cant_sd_mean = mean(Cant_sd, na.rm = TRUE),
#             Cant_pos_mean_sd = sd(Cant_pos_mean, na.rm = TRUE),
#             Cant_pos_mean = mean(Cant_pos_mean, na.rm = TRUE),
#             Cant_pos_sd_mean = mean(Cant_pos_sd, na.rm = TRUE),
#             gamma_mean = mean(gamma_mean)) %>% 
#   ungroup()


Cant_predictor_average_zonal_Atl <- Cant_predictor_average_zonal %>% 
  filter(basin == "Atlantic") %>% 
  mutate(gamma_slab = cut(gamma_mean_mean, parameters$slabs_Atl))

Cant_predictor_average_zonal_Ind_Pac <- Cant_predictor_average_zonal %>% 
  filter(basin == "Indo-Pacific") %>% 
  mutate(gamma_slab = cut(gamma_mean_mean, parameters$slabs_Ind_Pac))

Cant_predictor_average_zonal <- bind_rows(Cant_predictor_average_zonal_Atl, Cant_predictor_average_zonal_Ind_Pac)

rm(Cant_predictor_average_zonal_Atl, Cant_predictor_average_zonal_Ind_Pac)

```

## Inventory calculation

To calculate Cant column inventories, we:  

1. Multiple layer thickness with Cant concentration to get a layer inventory
2. For each horizontal grid cell and era, sum Cant layer inventories from 150 - 3000 m

Step 2 is performed again for all Cant and positive Cant values only

```{r calculate_inventories}

depth_level_volume <- tibble(depth = unique(Cant_average$depth))

depth_level_volume <- depth_level_volume %>%
  mutate(
    layer_thickness_above = replace_na((depth - lag(depth)) / 2, 0),
    layer_thickness_below = replace_na((lead(depth) - depth) / 2, 0),
    layer_thickness = layer_thickness_above + layer_thickness_below
  ) %>%
  select(-c(layer_thickness_above,
            layer_thickness_below))

Cant_average <-
  full_join(Cant_average, depth_level_volume)

Cant_average <- Cant_average %>%
  mutate(layer_inv = Cant_mean * layer_thickness) %>%
  mutate(layer_inv_pos = if_else(layer_inv < 0, 0, layer_inv)) %>%
  select(-layer_thickness)

Cant_inv <- Cant_average %>%
  filter(depth <= parameters$inventory_depth) %>%
  group_by(lon, lat, basin, eras) %>%
  summarise(
    cant_inv_pos = sum(layer_inv_pos, na.rm = TRUE) / 1000,
    cant_inv     = sum(layer_inv, na.rm = TRUE) / 1000
  ) %>%
  ungroup()


```


# Write csv

```{r write_cant_files}

# Cant %>%
#     write_csv(here::here("data/mapping/_summarized_files",
#                          "Cant.csv"))

Cant_average %>%
    write_csv(here::here("data/mapping/_summarized_files",
                         "Cant_average.csv"))

Cant_predictor_average %>%
    write_csv(here::here("data/mapping/_summarized_files",
                         "Cant_predictor_average.csv"))

Cant_average_zonal %>%
    write_csv(here::here("data/mapping/_summarized_files",
                         "Cant_average_zonal.csv"))

Cant_predictor_average_zonal %>%
    write_csv(here::here("data/mapping/_summarized_files",
                         "Cant_predictor_average_zonal.csv"))

Cant_inv %>%
    write_csv(here::here("data/mapping/_summarized_files",
                         "Cant_inv.csv"))

rm(Cant,
   Cant_average,
   Cant_predictor_average,
   Cant_average_zonal,
   Cant_predictor_average_zonal,
   Cant_inv)

```


