---
title: "Mapping"
author: "Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r library, message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(oce)
```


```{r ggplot_theme, include = FALSE}
theme_set(theme_bw())
```

# Required data

Currently we use following data sets for mapping: 

- GLODAPv2_2016b_MappedClimatologies
- World Ocean Atlas 2013 neutral densities
- eMLR model coefficients

```{r load_GLODAPv2_2016b_MappedClimatologies}

variables <- c("salinity", "temperature", "NO3", "oxygen", "PO4", "silicate")

for (i_variable in variables) {
  
  #i_variable <- variables[2]
  print(i_variable)
  temp <- read_csv(
    here::here("data/GLODAPv2_2016b_MappedClimatologies/_summarized_files",
               paste(i_variable,".csv", sep = "")))
  
  if (exists("GLODAP_predictors")) {
     GLODAP_predictors <- full_join(GLODAP_predictors, temp)
  }
  
  if (!exists("GLODAP_predictors")) {
    GLODAP_predictors <- temp
  }

}

rm(temp, i_variable, variables)

GLODAP_depths <- unique(GLODAP_predictors$depth)

GLODAP_lon <- unique(GLODAP_predictors$lon)
min(GLODAP_lon)
max(GLODAP_lon)

```

```{r load_WOA18, eval=FALSE}

WOA18_predictors <-
  read_csv(here::here("data/World_Ocean_Atlas_2018/_summarized_files",
                       "WOA18_predictors.csv"))

WOA18_predictors <- WOA18_predictors %>% 
  rename(salinity = s_an, temperature = t_an)

WOA18_depths <- unique(WOA18_predictors$depth)


```

```{r load_WOA13_gamma}

WOA13 <-
  read_csv(here::here("data/World_Ocean_Atlas_2018/_summarized_files",
                       "WOA13_mask_gamma.csv"))

WOA13_gamma <- WOA13 %>% 
  select(-mask)

WOA13_gamma <- WOA13_gamma %>% 
  rename(lat = latitude, lon = longitude) %>% 
  mutate(lon = if_else(lon > 180, lon - 360, lon))

rm(WOA13)

# WOA13_depths <- unique(WOA13_gamma$depth)
# GLODAP_depths - WOA13_depths

```

```{r load_eMLR_coeffcients}

all_lm <- read_csv(here::here("data/eMLR",
                              "all_lm.csv"))

```



# Join predictor climatologies

**CAVEAT**: Coverage of GLODAP climatologies differs slightly for parameters (some are NA in some regions)

## Control plots

```{r control_plots_pre_merging}

GLODAP_n <- GLODAP_predictors %>% 
  drop_na() %>% 
  group_by(lat, lon) %>% 
  summarise(n = n()) %>% 
  ungroup()

GLODAP_n %>%
  ggplot(aes(lon, lat, fill = n)) +
  geom_raster() +
  scale_fill_viridis_c(direction = -1) +
  coord_quickmap(expand = 0) +
  theme(legend.position = "bottom")

WOA13_gamma_n <- WOA13_gamma %>% 
  drop_na() %>% 
  group_by(lat, lon) %>% 
  summarise(n = n()) %>% 
  ungroup()

WOA13_gamma_n %>%
  ggplot(aes(lon, lat, fill = n)) +
  geom_raster() +
  scale_fill_viridis_c(direction = -1) +
  coord_quickmap(expand = 0) +
  theme(legend.position = "bottom")

rm(GLODAP_n, WOA13_gamma_n)

```


## WOA13

```{r join_WOA13_GLODAP_predictors, fig.asp=0.5}

predictors <- full_join(GLODAP_predictors, WOA13_gamma)
rm(GLODAP_predictors, WOA13_gamma)

predictors <- predictors %>% 
  group_by(lat, lon) %>% 
  mutate(n_NO3 = sum(!is.na(NO3)),
         n_oxygen = sum(!is.na(oxygen)),
         n_PO4 = sum(!is.na(PO4)),
         n_silicate = sum(!is.na(silicate)),
         n_salinity = sum(!is.na(salinity)),
         n_temperature = sum(!is.na(temperature)),
         n_gamma = sum(!is.na(gamma))) %>% 
  ungroup()

predictors <- predictors %>% 
  filter(n_NO3 > 0,
         n_oxygen > 0,
         n_PO4 > 0,
         n_silicate > 0, 
         n_salinity > 0, 
         n_temperature > 0, 
         n_gamma > 0) %>% 
  select(-c(n_NO3, 
            n_oxygen, 
            n_PO4, 
            n_silicate, 
            n_salinity, 
            n_temperature,
            n_gamma))

predictors <- predictors %>% 
  drop_na()

predictors %>%
  ggplot(aes(lon, lat)) +
  geom_bin2d(binwidth = c(1,1)) +
  scale_fill_viridis_c(direction = -1) +
  coord_quickmap(expand = 0) +
  theme(legend.position = "bottom")

predictors %>%
  filter(depth == 0) %>% 
  ggplot(aes(lon, lat, fill = PO4)) +
  geom_raster() +
  scale_fill_viridis_c() +
  coord_quickmap(expand = 0) +
  theme(legend.position = "bottom") +
  labs(title = "Surface values")

predictors %>%
  filter(depth == 0) %>% 
  ggplot(aes(lon, lat, fill = temperature)) +
  geom_raster() +
  scale_fill_viridis_c() +
  coord_quickmap(expand = 0) +
  theme(legend.position = "bottom") +
  labs(title = "Surface values")

predictors %>%
  filter(depth == 0) %>% 
  ggplot(aes(lon, lat, fill = gamma)) +
  geom_raster() +
  scale_fill_viridis_c() +
  coord_quickmap(expand = 0) +
  theme(legend.position = "bottom") +
  labs(title = "Surface values")

```


## WOA18 (not used)

```{r join_WOA18_GLODAP_predictors, fig.asp=0.5, eval=FALSE}

predictors <- full_join(GLODAP_predictors, WOA18_predictors)
rm(GLODAP_predictors, WOA18_predictors)

predictors <- predictors %>% 
  group_by(lat, lon) %>% 
  mutate(n_NO3 = sum(!is.na(NO3)),
         n_oxygen = sum(!is.na(oxygen)),
         n_PO4 = sum(!is.na(PO4)),
         n_silicate = sum(!is.na(silicate)),
         n_salinity = sum(!is.na(salinity)),
         n_temperature = sum(!is.na(temperature))) %>% 
  ungroup()

predictors <- predictors %>% 
  filter(n_NO3 > 1,
         n_oxygen > 1,
         n_PO4 > 1,
         n_silicate > 1, 
         n_salinity > 1, 
         n_temperature > 1) %>% 
  select(-c(n_NO3 , n_oxygen , n_PO4 , n_silicate , n_salinity , n_temperature))

predictors %>%
  ggplot(aes(lon, lat)) +
  geom_bin2d(binwidth = c(1,1)) +
  scale_fill_viridis_c(direction = -1) +
  coord_quickmap(expand = 0) +
  theme(legend.position = "bottom")

predictors %>%
  filter(depth == 0) %>% 
  ggplot(aes(lon, lat, fill = PO4)) +
  geom_raster() +
  scale_fill_viridis_c() +
  coord_quickmap(expand = 0) +
  theme(legend.position = "bottom") +
  labs(title = "Surface values")

predictors %>%
  filter(depth == 0) %>% 
  ggplot(aes(lon, lat, fill = temperature)) +
  geom_raster() +
  scale_fill_viridis_c() +
  coord_quickmap(expand = 0) +
  theme(legend.position = "bottom") +
  labs(title = "Surface values")


```

```{r interpolate_WOA18_vertically, eval=FALSE}

predictors <- predictors %>% 
  group_by(lat, lon) %>% 
  arrange(depth) %>% 
  mutate(temperature = approxfun(depth, temperature, rule = 2)(depth),
         salinity = approxfun(depth, salinity, rule = 2)(depth)) %>% 
  ungroup()


predictors <- predictors %>% 
  filter(depth %in% GLODAP_depths)


```

### Predictor profiles

```{r predictor_profiles_N_Atl}

N_Atl <- predictors %>% 
  filter(lat == 40.5, lon == -20.5)

N_Atl <- N_Atl %>% 
  pivot_longer(salinity:gamma, names_to = "parameter", values_to = "value")

N_Atl %>% 
  ggplot(aes(value, depth)) +
  geom_path() +
  geom_point() +
  scale_y_reverse() +
  facet_wrap(~parameter, scales = "free_x")

rm(N_Atl)

```

# Prepare model coefficients

```{r prepare_model_coefficients}

all_lm <- all_lm %>% 
  select(term, estimate, basin, era, gamma_slab, model)

all_lm_wide <- all_lm %>% 
  pivot_wider(values_from = estimate, names_from = term)


```




# Neutral density calculation

```{r calculate_neutral_density_test, fig.asp=0.5}

GLODAP <- read_csv(here::here("data/GLODAPv2_2020/_summarized_data_files",
                                "GLODAP_MLR_fitting_ready.csv"))

cruises_meridional <- c("1041")

GLODAP_cruise <- GLODAP %>% 
  filter(cruise %in% cruises_meridional)


GLODAP_cruise <- GLODAP_cruise %>% 
  mutate(gamma_calc = swRho(salinity = salinity,
                            temperature = temperature,
                            pressure = depth,
                            longitude = lon,
                            latitude = lat,
                            eos = "gsw"))


GLODAP_cruise <- GLODAP_cruise %>% 
  mutate(gamma_calc = gamma_calc - 1000,
         delta_gamma = gamma - gamma_calc)


lat_section <- 
GLODAP_cruise %>%
  ggplot(aes(lat, depth)) +
  scale_y_reverse() +
  scale_color_viridis_c() +
  theme(legend.position = "bottom")

lat_section +
  geom_point(aes(col = gamma))

lat_section +
  geom_point(aes(col = gamma_calc))

lat_section +
  geom_point(aes(col = delta_gamma))

```

