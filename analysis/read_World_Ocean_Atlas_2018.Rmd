---
title: "World Ocean Atlas 2018"
author: "Jens Daniel Müller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r library, message=FALSE, warning=FALSE}
library(tidyverse)
library(tidync)
library(reticulate)
library(oce)
library(gsw)
```

```{r read_parameters, include = FALSE}
parameters <-
  read_rds(here::here("data",
                       "parameters.rds"))
```

```{r read_functions, include = FALSE}
source(here::here("code", "plotting_functions.R"))
```

```{r ggplot_theme, include = FALSE}
theme_set(theme_bw())
```

# Data source
- Data source: [World Ocean Atlas 2018](https://www.nodc.noaa.gov/OC5/woa18/woa18data.html){target="_blank"}

# Masks

## Basins

### Read mask

The surface mask (0m) with 1x1° resolution from the file `basinmask_01.msk` was used.

```{r read_basinmask}

basinmask_01 <- read_csv(here::here("data/World_Ocean_Atlas_2018",
                                    "basinmask_01.msk"),
                         skip = 1,
                         col_types = list(.default = "d"))

basinmask_01 <- basinmask_01 %>% 
  select(Latitude:Basin_0m) %>% 
  mutate(Basin_0m = as.factor(Basin_0m)) %>% 
  rename(lat = Latitude, lon = Longitude)
  
```


### Labels

According to [WOA FAQ](https://www.nodc.noaa.gov/OC5/WOD/wod-woa-faqs.html){target="_blank"} website and [WOA18 documentation](https://data.nodc.noaa.gov/woa/WOA18/DOC/woa18documentation.pdf){target="_blank"}, number codes in the mask files were used to assign ocean basins as follows:  

Atlantic Ocean:  

- 1: Atlantic Ocean
- 10: Southern Ocean between 63°W and 20°E
- 11: Arctic Ocean (restricted by northern latitude limit `r parameters$lat_max`N)

Indian Ocean:  

- 3: Indian Ocean 
- 10: Southern Ocean between 20°E and 147°E

Pacific Ocean:  

- 2: Pacific Ocean
- 10: Southern Ocean between 147°E and 63°W
- 12: Sea of Japan
- 56: Bay of Bengal

For eMLR model fitting and mapping, Indian and Pacific Ocean were combined as Indo-Pacific.

```{r assign_basin_labels}

basinmask_01 <- basinmask_01 %>% 
  filter(Basin_0m %in% c("1", "2", "3", "10", "11", "12", "56"),
         lat <= parameters$lat_max) %>% 
  mutate(basin_AIP = "none",
         basin_AIP = case_when(
           Basin_0m == "1" ~ "Atlantic",
           Basin_0m == "10" & lon >= -63 & lon < 20 ~ "Atlantic",
           Basin_0m == "11" ~ "Atlantic",
           Basin_0m == "3" ~ "Indian",
           Basin_0m == "10" & lon >= 20 & lon < 147 ~ "Indian",
           Basin_0m == "2" ~ "Pacific",
           Basin_0m == "12" ~ "Pacific",
           Basin_0m == "56" ~ "Pacific",
           Basin_0m == "10" & lon >= 147 | lon < -63 ~ "Pacific")) %>% 
  mutate(basin = if_else(basin_AIP == "Atlantic",
                         "Atlantic",
                         "Indo-Pacific")) %>% 
  select(-Basin_0m) %>% 
  mutate(lon = if_else(lon < 20, lon + 360, lon))

```

## Land

### Read mask

The land sea mask with 1x1° resolution from the file `landsea_01.msk` was used.

```{r read_landsea_mask}

landsea_01 <- read_csv(here::here("data/World_Ocean_Atlas_2018",
                                  "landsea_01.msk"),
                         skip = 1,
                         col_types = list(.default = "d"))

```

### Label

According to the [WOA18 documentation](https://data.nodc.noaa.gov/woa/WOA18/DOC/woa18documentation.pdf){target="_blank"} document:  

*"The landsea_XX.msk contains the standard depth level number at which the bottom of the ocean is first encountered at each quarter-degree or one-degree square for the entire world.  Land will have a value of 1, corresponding to the surface."*

The landmask was derived as coordinates with value 1.

```{r assign_region_labels}

landmask <- landsea_01 %>% 
  mutate(region = if_else(Bottom_Standard_Level == "1",
                         "land", "ocean")) %>% 
  select(-Bottom_Standard_Level)

landmask <- landmask %>% 
  rename(lat = Latitude,
         lon = Longitude) %>% 
  mutate(lon = if_else(lon < 20, lon + 360, lon))

rm(landsea_01)
```


## Map

```{r basin_masks_WOA18_map}

ggplot() +
  geom_raster(data = landmask %>% filter(region == "land"),
              aes(lon, lat), fill = "grey80") +
  geom_raster(data = basinmask_01,
              aes(lon, lat, fill = basin_AIP)) +
  scale_fill_brewer(palette = "Dark2") +
  coord_quickmap(expand = 0) +
  theme(legend.position = "top",
        legend.title = element_blank())

```


## Write files

```{r write_files}

basinmask_01 %>% 
  write_csv(here::here("data/World_Ocean_Atlas_2018/_summarized_files",
                       "basin_mask_WOA18.csv"))

landmask %>% 
  write_csv(here::here("data/World_Ocean_Atlas_2018/_summarized_files",
                       "land_mask_WOA18.csv"))

```


# Climatologies

Copied from the WOA FAQ website, the file naming conventions is:  

PREF_DDDD_VTTFFGG.EXT, where:

- PREF: prefix
- DDDD: decade
- V: variable
- TT: time period
- FF: field type
- GG: grid (5deg- 5°, 01- 1°, 04 - 1/4°)
- EXT: file extention

Short description of two statistical fields in WOA

- Objectively analyzed climatologies are the objectively interpolated mean fields for oceanographic variables at standard - depth levels for the World Ocean.
- The statistical mean is the average of all unflagged interpolated values at each standard depth level for each variable - in each 1° square which contains at least one measurement for the given oceanographic variable.

Here, we use  

- Fields: objectively analyzed mean
- Decades: all decades
- Grid: 1 deg resolution

According to the [WOA18 documentation](https://data.nodc.noaa.gov/woa/WOA18/DOC/woa18documentation.pdf){target="_blank"} document:

*What are the units for temperature and salinity in the WOA18?*

*In situ temperatures used for WOA18 are not converted from their original scale, so there is a mix of IPTS-48, IPTS-68, and ITS-90 (and pre IPTS-48 temperatures). The differences between scales are small (on the order of 0.01°C) and should not have much effect on the climatological means, except, possibly at very deep depths. Values for salinity are on the Practical salinity scale (PSS-78). Pre-1978 salinity values converted from conductivity may have used a different salinity scale. Pre-conductivity salinities use the Knudsen method.* 


## Read ncdfs

```{r read_WOA18}

# temperature

WOA_tem <- tidync(here::here("data/World_Ocean_Atlas_2018",
                                 "woa18_decav_t00_01.nc"))

WOA_tem_tibble <- WOA_tem %>% hyper_tibble()

WOA_tem_tibble <- WOA_tem_tibble  %>% 
  select(tem = t_an, lon, lat, depth) %>% 
  drop_na() %>% 
  mutate(lon = if_else(lon < 20, lon + 360, lon))

# salinity

WOA_sal <- tidync(here::here("data/World_Ocean_Atlas_2018",
                                 "woa18_decav_s00_01.nc"))

WOA_sal_tibble <- WOA_sal %>% hyper_tibble()

WOA_sal_tibble <- WOA_sal_tibble  %>% 
  select(sal = s_an, lon, lat, depth) %>% 
  drop_na() %>% 
  mutate(lon = if_else(lon < 20, lon + 360, lon))

rm(WOA_sal, WOA_tem)

```


```{r join_predictors}

WOA18_predictors <- full_join(WOA_sal_tibble, WOA_tem_tibble)
rm(WOA_sal_tibble, WOA_tem_tibble)

```


## Apply basin mask

Data outside the WOA18 basin mask were removed for further analysis.

```{r join_basin_mask}

WOA18_predictors <- inner_join(WOA18_predictors, basinmask_01)
#rm(basinmask_01)

```


## Potential temperature

### Calculation

```{r WOA18_potential_temperature_calculation}

WOA18_predictors <- WOA18_predictors %>% 
  mutate(THETA = swTheta(salinity = sal,
                         temperature = tem,
                         pressure = depth,
                         referencePressure = 0,
                         longitude = lon - 180,
                         latitude = lat))

```

### Profile

Example profile from North Atlantic Ocean.

```{r WOA18_potential_temperature_profile}
WOA18_predictors %>%
  filter(lat == parameters$lat_Atl_profile,
         lon == parameters$lon_Atl_section) %>%
  ggplot() +
  geom_line(aes(tem, depth, col = "insitu")) +
  geom_point(aes(tem, depth, col = "insitu")) +
  geom_line(aes(THETA, depth, col = "theta")) +
  geom_point(aes(THETA, depth, col = "theta")) +
  scale_y_reverse() +
  scale_color_brewer(palette = "Dark2", name = "Scale")

```

## Neutral density

Neutral density gamma was calculated with a Python script provided by Serazin et al (2011), which performs a polynomial approximation of the original gamma calculation.

### Calculation

```{r WOA18_neutral_density_calculations, eval=FALSE}

# calculate pressure from depth

WOA18_predictors <- WOA18_predictors %>% 
  mutate(CTDPRS = gsw_p_from_z(-depth,
                               lat))
# rename variables according to python script

WOA18_predictors_gamma_prep <- WOA18_predictors %>% 
  rename(LATITUDE = lat,
         LONGITUDE = lon,
         SALNTY = sal)

# load python scripts

source_python(here::here("code/python_scripts",
                         "Gamma_GLODAP_python.py"))

# calculate gamma

WOA18_predictors_gamma_calc <- calculate_gamma(WOA18_predictors_gamma_prep)

```

### Write/open file

```{r write_WOA_predictor_file, eval=FALSE}

WOA18_predictors <- WOA18_predictors_gamma_calc %>% 
  select(-c(CTDPRS, THETA)) %>% 
  rename(lat = LATITUDE,
         lon = LONGITUDE,
         sal = SALNTY,
         gamma  = GAMMA)

WOA18_predictors %>% 
  write_csv(here::here("data/World_Ocean_Atlas_2018/_summarized_files",
                       "WOA18_predictors.csv"))

```

```{r read_WOA_predictor_file_gamma}

rm(list = setdiff(ls(), c("landmask", "parameters")))
source(here::here("code", "plotting_functions.R"))

WOA18_predictors <- 
  read_csv(here::here("data/World_Ocean_Atlas_2018/_summarized_files",
                       "WOA18_predictors.csv"))
```


## Temperature plots

Below, following subsets of the climatologies are plotted for all relevant parameters:  

- Horizontal planes at `r parameters$depth_levels`m
- Meridional sections at longitudes: `r parameters$longitude_sections_basin`

Section locations are indicated as white lines in maps.

### Surface map

```{r temperature_surface_WOA18_map, fig.asp=0.6}

map_climatology(WOA18_predictors, "tem")

```

### Sections

```{r temperature_sections_WOA18, fig.asp=0.8}

section_climatology(WOA18_predictors, "tem")

```

### Sections shallow

```{r temperature_sections_WOA18_shallow, fig.asp=0.8}

section_climatology_shallow(WOA18_predictors, "tem")

```




## Salinity plots

### Surface map

```{r salinity_surface_WOA18_map}

map_climatology(WOA18_predictors, "sal")

```

### Sections

```{r salinity_sections_WOA18, fig.asp=0.8}

section_climatology(WOA18_predictors, "sal")

```

### Sections shallow

```{r salinity_sections_WOA18_shallow, fig.asp=0.8}

section_climatology_shallow(WOA18_predictors, "sal")

```



## Neutral density plots

### Surface map

```{r neutral_density_surface_WOA18_map}

map_climatology(WOA18_predictors, "gamma")

```

### Sections

```{r neutral_density_sections_WOA18, fig.asp=0.8}

section_climatology(WOA18_predictors, "gamma")

```

### Sections shallow

```{r neutral_density_sections_WOA18_shallow, fig.asp=0.8}

section_climatology_shallow(WOA18_predictors, "gamma")

```


# Open tasks

- 

# Questions

- Which version of the WOA to be used
  - Fields (currently: objectively analyzed mean)
  - Decades (currently: all decades)
  - Grid (currently: 1 deg resolution)
