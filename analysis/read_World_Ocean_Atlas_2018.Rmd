---
title: "World Ocean Atlas 2018"
author: "Jens Daniel Müller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r library, message=FALSE, warning=FALSE}
library(tidyverse)
library(tidync)
library(reticulate)
library(oce)
library(gsw)
library(geosphere)
library(patchwork)
```

```{r read_parameters, include = FALSE}
parameters <-
  read_rds(here::here("data",
                       "parameters.rds"))
```

```{r read_functions, include = FALSE}
source(here::here("code", "plotting_functions.R"))
```

```{r ggplot_theme, include = FALSE}
theme_set(theme_bw())
```

# Data source
- Data source: [World Ocean Atlas 2018](https://www.nodc.noaa.gov/OC5/woa18/woa18data.html){target="_blank"}

# Masks


## Land

### Read mask

The land sea mask with 1x1° resolution from the file `landsea_01.msk` was used.

```{r read_landsea_mask}

landsea_01 <- read_csv(here::here("data/World_Ocean_Atlas_2018",
                                  "landsea_01.msk"),
                         skip = 1,
                         col_types = list(.default = "d"))

```

### Label

According to the [WOA18 documentation](https://data.nodc.noaa.gov/woa/WOA18/DOC/woa18documentation.pdf){target="_blank"} document:  

*"The landsea_XX.msk contains the standard depth level number at which the bottom of the ocean is first encountered at each quarter-degree or one-degree square for the entire world.  Land will have a value of 1, corresponding to the surface."*

The landmask was derived as coordinates with value 1.

```{r assign_region_labels}

landmask <- landsea_01 %>% 
  mutate(region = if_else(Bottom_Standard_Level == "1",
                         "land", "ocean")) %>% 
  select(-Bottom_Standard_Level)

landmask <- landmask %>% 
  rename(lat = Latitude,
         lon = Longitude) %>% 
  mutate(lon = if_else(lon < 20, lon + 360, lon))

landmask <- landmask %>%
  filter(region == "land", 
         lat >= parameters$lat_min,
         lat <= parameters$lat_max) %>% 
  select(-region)

rm(landsea_01)
```

## Basins

### Read mask

The surface mask (0m) with 1x1° resolution from the file `basinmask_01.msk` was used.

```{r read_basinmask}

basinmask_01 <- read_csv(here::here("data/World_Ocean_Atlas_2018",
                                    "basinmask_01.msk"),
                         skip = 1,
                         col_types = list(.default = "d"))

basinmask_01 <- basinmask_01 %>% 
  select(Latitude:Basin_0m) %>% 
  mutate(Basin_0m = as.factor(Basin_0m)) %>% 
  rename(lat = Latitude, lon = Longitude)
  
```


### Labels

According to [WOA FAQ](https://www.nodc.noaa.gov/OC5/WOD/wod-woa-faqs.html){target="_blank"} website and [WOA18 documentation](https://data.nodc.noaa.gov/woa/WOA18/DOC/woa18documentation.pdf){target="_blank"}, number codes in the mask files were used to assign ocean basins as follows:  

Atlantic Ocean:  

- 1: Atlantic Ocean
- 10: Southern Ocean between 63°W and 20°E
- 11: Arctic Ocean (restricted by northern latitude limit `r parameters$lat_max`N)

Indian Ocean:  

- 3: Indian Ocean 
- 10: Southern Ocean between 20°E and 147°E

Pacific Ocean:  

- 2: Pacific Ocean
- 10: Southern Ocean between 147°E and 63°W
- 12: Sea of Japan
- 56: Bay of Bengal

For eMLR model fitting and mapping, Indian and Pacific Ocean were combined as Indo-Pacific.

```{r assign_basin_labels}

basinmask_01 <- basinmask_01 %>% 
  filter(Basin_0m %in% c("1", "2", "3", "10", "11", "12", "56"),
         lat <= parameters$lat_max) %>% 
  mutate(basin_AIP = "none",
         basin_AIP = case_when(
           Basin_0m == "1" ~ "Atlantic",
           Basin_0m == "10" & lon >= -63 & lon < 20 ~ "Atlantic",
           Basin_0m == "11" ~ "Atlantic",
           Basin_0m == "3" ~ "Indian",
           Basin_0m == "56" ~ "Indian",
           Basin_0m == "10" & lon >= 20 & lon < 147 ~ "Indian",
           Basin_0m == "2" ~ "Pacific",
           Basin_0m == "12" ~ "Pacific",
           Basin_0m == "10" & lon >= 147 | lon < -63 ~ "Pacific")) %>% 
  mutate(basin = if_else(basin_AIP == "Atlantic",
                         "Atlantic",
                         "Indo-Pacific")) %>% 
  select(-Basin_0m) %>% 
  mutate(lon = if_else(lon < 20, lon + 360, lon))

```

### Map

```{r basin_masks_WOA18_map, fig.asp=0.6}

ggplot() +
  geom_raster(data = landmask,
              aes(lon, lat), fill = "grey80") +
  geom_raster(data = basinmask_01,
              aes(lon, lat, fill = basin_AIP)) +
  scale_fill_brewer(palette = "Dark2") +
  coord_quickmap(expand = 0) +
  theme(legend.position = "top",
        legend.title = element_blank(),
        axis.title = element_blank())

```


## Global section

To plot sections from the North Atlantic south to the Southern Ocean, around Antartica and back North across the Pacific Ocean, corresponding coordinates were subsetted from the basin mask and distances between coordinate grid points calculated.

```{r Create_section_global}

section <- basinmask_01 %>%
  select(lon, lat)

Atl_NS <- section %>%
  filter(
    lon == parameters$lon_Atl_section,
    lat <= parameters$lat_section_N,
    lat >= parameters$lat_section_S
  ) %>%
  arrange(-lat)

Atl_SO <- section %>%
  filter(lon > parameters$lon_Atl_section,
         lat == parameters$lat_section_S) %>%
  arrange(lon)

Pac_SO <- section %>%
  filter(lon < parameters$lon_Pac_section,
         lat == parameters$lat_section_S) %>%
  arrange(lon)

Pac_SN <- section %>%
  filter(
    lon == parameters$lon_Pac_section,
    lat <= parameters$lat_section_N,
    lat >= parameters$lat_section_S
  ) %>%
  arrange(lat)

section_global_coordinates <- bind_rows(Atl_NS,
                     Atl_SO,
                     Pac_SO,
                     Pac_SN)

section_global_coordinates <- section_global_coordinates %>%
  mutate(lon_180 = if_else(lon > 180, lon - 360, lon))

section_global_coordinates <- section_global_coordinates %>%
  mutate(dist_int = distGeo(cbind(lon_180, lat)) / 1e6) %>%
  mutate(dist = cumsum(dist_int))


section_global_coordinates <- section_global_coordinates %>%
  select(lon, lat, dist) %>% 
  drop_na()

rm(Atl_NS, Atl_SO, Pac_SN, Pac_SO, section)

```

```{r section_global_map, fig.asp=0.6}

ggplot() +
  geom_raster(data = landmask,
              aes(lon, lat), fill = "grey80") +
  geom_point(data = section_global_coordinates,
             aes(lon, lat, col = dist)) +
  scale_fill_grey() +
  scale_colour_viridis_b(name = "Distance (Mm)") +
  coord_quickmap(expand = 0) +
  theme(legend.position = "top",
        axis.title = element_blank())

```




## Write files

```{r write_files}

basinmask_01 %>% 
  write_csv(here::here("data/World_Ocean_Atlas_2018/_summarized_files",
                       "basin_mask_WOA18_AIP.csv"))

basinmask_01 <- basinmask_01 %>% 
  select(-basin_AIP)

basinmask_01 %>% 
  write_csv(here::here("data/World_Ocean_Atlas_2018/_summarized_files",
                       "basin_mask_WOA18.csv"))

landmask %>% 
  write_csv(here::here("data/World_Ocean_Atlas_2018/_summarized_files",
                       "land_mask_WOA18.csv"))

section_global_coordinates %>%
  write_csv(here::here("data",
                       "section_global_coordinates.csv"))

```


# Climatologies

Copied from the WOA FAQ website, the file naming conventions is:  

PREF_DDDD_VTTFFGG.EXT, where:

- PREF: prefix
- DDDD: decade
- V: variable
- TT: time period
- FF: field type
- GG: grid (5deg- 5°, 01- 1°, 04 - 1/4°)
- EXT: file extention

Short description of two statistical fields in WOA

- Objectively analyzed climatologies are the objectively interpolated mean fields for oceanographic variables at standard - depth levels for the World Ocean.
- The statistical mean is the average of all unflagged interpolated values at each standard depth level for each variable - in each 1° square which contains at least one measurement for the given oceanographic variable.

Here, we use  

- Fields: objectively analyzed mean
- Decades: all decades
- Grid: 1 deg resolution

According to the [WOA18 documentation](https://data.nodc.noaa.gov/woa/WOA18/DOC/woa18documentation.pdf){target="_blank"} document:

*What are the units for temperature and salinity in the WOA18?*

*In situ temperatures used for WOA18 are not converted from their original scale, so there is a mix of IPTS-48, IPTS-68, and ITS-90 (and pre IPTS-48 temperatures). The differences between scales are small (on the order of 0.01°C) and should not have much effect on the climatological means, except, possibly at very deep depths. Values for salinity are on the Practical salinity scale (PSS-78). Pre-1978 salinity values converted from conductivity may have used a different salinity scale. Pre-conductivity salinities use the Knudsen method.* 


## Read ncdfs

```{r read_WOA18}

# temperature

WOA_tem <- tidync(here::here("data/World_Ocean_Atlas_2018",
                                 "woa18_decav_t00_01.nc"))

WOA_tem_tibble <- WOA_tem %>% hyper_tibble()

WOA_tem_tibble <- WOA_tem_tibble  %>% 
  select(tem = t_an, lon, lat, depth) %>% 
  drop_na() %>% 
  mutate(lon = if_else(lon < 20, lon + 360, lon))

# salinity

WOA_sal <- tidync(here::here("data/World_Ocean_Atlas_2018",
                                 "woa18_decav_s00_01.nc"))

WOA_sal_tibble <- WOA_sal %>% hyper_tibble()

WOA_sal_tibble <- WOA_sal_tibble  %>% 
  select(sal = s_an, lon, lat, depth) %>% 
  drop_na() %>% 
  mutate(lon = if_else(lon < 20, lon + 360, lon))

rm(WOA_sal, WOA_tem)

```


```{r join_predictors}

WOA18_predictors <- full_join(WOA_sal_tibble, WOA_tem_tibble)
rm(WOA_sal_tibble, WOA_tem_tibble)

```


## Apply basin mask

Data outside the WOA18 basin mask were removed for further analysis.

```{r join_basin_mask}

WOA18_predictors <- inner_join(WOA18_predictors, basinmask_01)

```


## Apply spatial boundaries

Only predictors were taken into consideration with:

- minimum bottom depth:  `r parameters$bottomdepth_min`m

```{r apply_bottomdepth_threshold}

WOA18_predictors_grid <- WOA18_predictors %>% 
  group_by(lat, lon) %>% 
  summarise(bottomdepth = max(depth)) %>% 
  ungroup()

WOA18_predictors_grid <- WOA18_predictors_grid %>% 
  filter(bottomdepth >= parameters$bottomdepth_min) %>% 
  select(-bottomdepth)

WOA18_predictors <- left_join(WOA18_predictors_grid, WOA18_predictors)

```

Only predictors were taken into consideration with:

- maximum depth:  `r parameters$inventory_depth`m

```{r apply_depth_threshold}

WOA18_predictors <- WOA18_predictors %>% 
  filter(depth <= parameters$inventory_depth)

```


## Potential temperature

### Calculation

```{r calculate_potential_temperature}

WOA18_predictors <- WOA18_predictors %>% 
  mutate(THETA = swTheta(salinity = sal,
                         temperature = tem,
                         pressure = depth,
                         referencePressure = 0,
                         longitude = lon - 180,
                         latitude = lat))

```


### Profile

Example profile from North Atlantic Ocean.

```{r WOA18_potential_temperature_profile}
WOA18_predictors %>%
  filter(lat == parameters$lat_Atl_profile,
         lon == parameters$lon_Atl_section) %>%
  ggplot() +
  geom_line(aes(tem, depth, col = "insitu")) +
  geom_point(aes(tem, depth, col = "insitu")) +
  geom_line(aes(THETA, depth, col = "theta")) +
  geom_point(aes(THETA, depth, col = "theta")) +
  scale_y_reverse() +
  scale_color_brewer(palette = "Dark2", name = "Scale")

```

### Section

```{r WOA18_pot_temperature_section}

section_global_coordinates <-
  read_csv(here::here("data",
                      "section_global_coordinates.csv"))

section_global(WOA18_predictors, "THETA")

```



## Neutral density

Neutral density gamma was calculated with a Python script provided by Serazin et al (2011), which performs a polynomial approximation of the original gamma calculation.

### Calculation

```{r calculate_neutral_density}

# calculate pressure from depth

WOA18_predictors <- WOA18_predictors %>% 
  mutate(CTDPRS = gsw_p_from_z(-depth,
                               lat))
# rename variables according to python script

WOA18_predictors_gamma_prep <- WOA18_predictors %>% 
  rename(LATITUDE = lat,
         LONGITUDE = lon,
         SALNTY = sal)

# load python scripts

source_python(here::here("code/python_scripts",
                         "Gamma_GLODAP_python.py"))

# calculate gamma

WOA18_predictors_gamma_calc <- calculate_gamma(WOA18_predictors_gamma_prep)

# reverse variabel naming

WOA18_predictors <- WOA18_predictors_gamma_calc %>% 
  select(-c(CTDPRS, THETA)) %>% 
  rename(lat = LATITUDE,
         lon = LONGITUDE,
         sal = SALNTY,
         gamma  = GAMMA)

WOA18_predictors <- as_tibble(WOA18_predictors)

rm(WOA18_predictors_gamma_calc, WOA18_predictors_gamma_prep)

```

### Apply density threshold

The predictor field was split into two parts:

1. Deep water: neutral densities >= `r parameters$gamma_min` and depth >= `r parameters$depth_min`m
2. Shallow water: rest

```{r apply_density_threshold}

WOA18_predictors_surface <- WOA18_predictors %>%
  filter(depth < parameters$depth_min,
         gamma < parameters$gamma_min)

WOA18_predictors <- WOA18_predictors %>%
  filter(depth >= parameters$depth_min | gamma >= parameters$gamma_min)


```

### Write/open file

```{r write_WOA18_predictor_file}

WOA18_predictors %>% 
  write_csv(here::here("data/World_Ocean_Atlas_2018/_summarized_files",
                       "WOA18_predictors.csv"))

WOA18_predictors_surface %>% 
  write_csv(here::here("data/World_Ocean_Atlas_2018/_summarized_files",
                       "WOA18_predictors_surface.csv"))

```

## Temperature plots

Below, following subsets of the climatologies are plotted for all relevant parameters:  

- Horizontal planes at `r parameters$depth_levels`m
- Meridional sections at longitudes: `r parameters$longitude_sections_basin`

Section locations are indicated as white lines in maps.

### Surface map

```{r temperature_surface_WOA18_map, fig.asp=0.6}

map_climatology(WOA18_predictors, "tem")

```

### Section

```{r temperature_sections_WOA18}

section_global(WOA18_predictors, "tem")

```


## Salinity plots

### Surface map

```{r salinity_surface_WOA18_map}

map_climatology(WOA18_predictors, "sal")

```

### Section

```{r salinity_sections_WOA18}

section_global(WOA18_predictors, "sal")

```




## Neutral density plots

### Surface map

```{r neutral_density_surface_WOA18_map}

map_climatology(WOA18_predictors, "gamma")

```

### Section

```{r neutral_density_sections_WOA18}

section_global(WOA18_predictors, "gamma")

```

### Surface map shallow

```{r neutral_density_surface_WOA18_map_shallow}

map_climatology(WOA18_predictors_surface, "gamma")

```

### Section shallow

```{r neutral_density_sections_WOA18_shallow}

section_global(WOA18_predictors_surface, "gamma")

```
