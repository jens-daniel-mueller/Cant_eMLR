---
title: "World Ocean Atlas 2018"
author: "Jens Daniel Müller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r library, message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(tidync)
library(stars)
```


```{r ggplot_theme, include = FALSE}
theme_set(theme_bw())
```

```{r read_parameters, include = FALSE}

parameters <- read_csv(here::here("data/parameters",
                                  "parameters.csv"))

depth_levels <- read_lines(here::here("data/parameters",
                                      "depth_levels.txt"))
```


# Data source
- Data source: [World Ocean Atlas 2018](https://www.nodc.noaa.gov/OC5/woa18/woa18data.html){target="_blank"}

# Masks

## Basins

### Read mask

The surface mask (0m) with 1x1° resolution from the file `basinmask_01.msk` was used.

```{r read_basinmask}

basinmask_01 <- read_csv(here::here("data/World_Ocean_Atlas_2018",
                                    "basinmask_01.msk"),
                         skip = 1,
                         col_types = list(.default = "d"))

basinmask_01 <- basinmask_01 %>% 
  select(Latitude:Basin_0m) %>% 
  mutate(Basin_0m = as.factor(Basin_0m)) %>% 
  rename(lat = Latitude, lon = Longitude)
  
```


### Labels

According to [WOA FAQ](https://www.nodc.noaa.gov/OC5/WOD/wod-woa-faqs.html){target="_blank"} website, number codes in the mask file refer to Ocean basins as follows:  

- 1: Atlantic Ocean (with 10 - Southern Ocean, between 63°W and 20°E)
- 2: Pacific Ocean (with 10 - Southern Ocean, between 147°E and 63°W)
- 3: Indian Ocean (with 10 - Southern Ocean, between 20°E and 147°E)

From this, the Atlantik and the Indo-Pacific were labeled.

```{r assign_basin_labels}

basinmask_01 <- basinmask_01 %>% 
  filter(Basin_0m %in% c("1", "2", "3", "10")) %>% 
  mutate(basin = if_else(Basin_0m == "10" & lon >= -63 & lon < 20,
                         "Atlantic", "Indo-Pacific"),
         basin = if_else(Basin_0m == "1",
                         "Atlantic", basin)) %>% 
  select(-Basin_0m) %>% 
  mutate(lon = if_else(lon < 20, lon + 360, lon))

```

## Land

### Read mask

The land sea mask with 1x1° resolution from the file `landsea_01.msk` was used.

```{r read_landsea_mask}

landsea_01 <- read_csv(here::here("data/World_Ocean_Atlas_2018",
                                  "landsea_01.msk"),
                         skip = 1,
                         col_types = list(.default = "d"))

landmask <- landsea_01 %>% 
  filter(Bottom_Standard_Level == 1) %>% 
  select(-Bottom_Standard_Level)

landmask <- landmask %>% 
  rename(lat = Latitude,
         lon = Longitude) %>% 
  mutate(lon = if_else(lon < 20, lon + 360, lon))

rm(landsea_01)
```

### Label

According to the [WOA18 documentation](https://data.nodc.noaa.gov/woa/WOA18/DOC/woa18documentation.pdf){target="_blank"} document: *"The landsea_XX.msk contains the standard depth level number at which the bottom of the ocean is first encountered at each quarter-degree or one-degree square for the entire world.  Land will have a value of 1, corresponding to the surface."*

The landmask was derived as coordinates with value 1.

## Plot map

```{r WOA18_map}

ggplot() +
  geom_raster(data = landmask,
              aes(lon, lat), fill = "grey80") +
  geom_raster(data = basinmask_01,
              aes(lon, lat, fill = basin)) +
  scale_fill_brewer(palette = "Dark2") +
  coord_quickmap(expand = 0) +
  theme(legend.position = "top",
        legend.title = element_blank())

```

## Write files

```{r write_files}

basinmask_01 %>% 
  write_csv(here::here("data/World_Ocean_Atlas_2018/_summarized_files",
                       "basin_mask_WOA18.csv"))

landmask %>% 
  write_csv(here::here("data/World_Ocean_Atlas_2018/_summarized_files",
                       "land_mask_WOA18.csv"))

rm(basinmask_01)

```


# WOA18 data

Copied from the WOA FAQ website, the file naming conventions is:  

PREF_DDDD_VTTFFGG.EXT, where:

- PREF: prefix
- DDDD: decade
- V: variable
- TT: time period
- FF: field type
- GG: grid (5deg- 5°, 01- 1°, 04 - 1/4°)
- EXT: file extention

Short description of the statistical fields in WOA

- Objectively analyzed climatologies are the objectively interpolated mean fields for oceanographic variables at standard - depth levels for the World Ocean.
- The statistical mean is the average of all unflagged interpolated values at each standard depth level for each variable - in each 1° square which contains at least one measurement for the given oceanographic variable.
- The number of observations of each variable in each 1° square of the World Ocean at each standard depth level.
- The standard deviation about the statistical mean of each variable in each 1° square at each standard depth level.
- The standard error of the mean of each variable in each 1° square at each standard depth level.
- The seasonal or monthly climatology minus the annual climatology at each 1° square at each standard depth.
- The statistical mean minus the climatological mean at each 1° square at each standard depth. This value is used as an estimate of interpolation and smoothing error.
- The number of 1° squares within the smallest radius of influence around each 1° square which contain a statistical mean.

Here, we use  

- Fields: objectively analyzed mean
- Decades: all decades
- Grid: 1 deg resolution

## Read ncdfs

```{r read_WOA18}

# temperature

WOA_tem <- tidync(here::here("data/World_Ocean_Atlas_2018",
                                 "woa18_decav_t00_01.nc"))

WOA_tem_tibble <- WOA_tem %>% hyper_tibble()

WOA_tem_tibble <- WOA_tem_tibble  %>% 
  select(tem = t_an, lon, lat, depth) %>% 
  drop_na() %>% 
  mutate(lon = if_else(lon < 20, lon + 360, lon))

# salinity

WOA_sal <- tidync(here::here("data/World_Ocean_Atlas_2018",
                                 "woa18_decav_s00_01.nc"))

WOA_sal_tibble <- WOA_sal %>% hyper_tibble()

WOA_sal_tibble <- WOA_sal_tibble  %>% 
  select(sal = s_an, lon, lat, depth) %>% 
  drop_na() %>% 
  mutate(lon = if_else(lon < 20, lon + 360, lon))

rm(WOA_sal, WOA_tem)

```


Below, following subsets of the climatologies are plotted for all relevant parameters:  

- Horizontal planes at `r depth_levels`m
- Meridional sections at longitudes:
  - Atlantic: `r parameters$lon_Atl_section`
  - Pacific: `r parameters$lon_Pac_section`

Section locations are indicated as white lines in maps.

Please note that longitudes in the climatologies range from -179.5 - 179.5, which is different from GLODAP mapped climatologies.



## Temperature plots

### Surface map

```{r temperature_surface_WOA18_map, fig.asp=0.6}

source(here::here("code",
                  "plotting_functions.R"))

map_climatology(WOA_tem_tibble, "tem")

```

### Sections

```{r temperature_section_WOA18_Atl, fig.asp=0.6}

section_climatology_Atl(WOA_tem_tibble, "tem")

```

```{r temperature_section_WOA18_Pac, fig.asp=0.6}

section_climatology_Pac(WOA_tem_tibble, "tem")

```



## Salinity plots

### Surface map

```{r salinity_surface_WOA18_map}

map_climatology(WOA_sal_tibble, "sal")

```


### Sections

```{r salinity_section_WOA18_Atl, fig.asp=0.6}

section_climatology_Atl(WOA_sal_tibble, "sal")

```

```{r salinity_section_WOA18_Pac, fig.asp=0.6}

section_climatology_Pac(WOA_sal_tibble, "sal")

```



## Write file

```{r write_WOA_predictor_file}

WOA18_predictors <- full_join(WOA_sal_tibble, WOA_tem_tibble)

WOA18_predictors %>% 
  write_csv(here::here("data/World_Ocean_Atlas_2018/_summarized_files",
                       "WOA18_predictors.csv"))

rm(WOA18_predictors, WOA_sal, WOA_sal_tibble, WOA_tem, WOA_tem_tibble)

```

# WOA13 from D. Clement

Dominic Clement provided a netcdf file with the basin mask and neutral densities used in Clement and Gruber (2018), both derived from the World Ocean Atlas 2013.

## Read ncdfs

```{r read_WOA13_dclement}

# temperature

nd_mask <- tidync(here::here("data/dclement",
                          "nd_mask.nc"))
nd_mask_tibble <- nd_mask %>% hyper_tibble()

nd_mask_tibble <- nd_mask_tibble %>% 
  mutate(gamma = if_else(gamma == -999, NaN, gamma))

```

## Plots

```{r set_criteria_horizons_sections_WOA13}

depth_surface_selection <- c(0)
Atl_lon <- 335.5
Pac_lon <- 190.5

```

Below, following subsets of the climatologies are plotted:  


- Basin mask at `r depth_surface_selection`m
- Meridional sections of neutral density at longitudes:
  - Atlantic: `r Atl_lon`
  - Pacific: `r Pac_lon`

Section locations are indicated as white lines in the basin map.

## Basin map

```{r basin_map_WOA13_dclement}

nd_mask_tibble %>% 
  filter(depth == 0) %>% 
  ggplot(aes(longitude, latitude, fill = as.factor(mask))) +
  geom_raster() +
  geom_vline(xintercept = c(Atl_lon, Pac_lon), col = "white") +
  coord_quickmap(expand = 0) +
  scale_fill_brewer(palette = "Set1",
                    name = "basin mask") +
  theme(legend.position = "top")

```

## Neutral density sections

### Atlantic

```{r gamma_section_WOA13_dclement_Atl}

nd_mask_tibble %>% 
  filter(longitude == Atl_lon) %>% 
  ggplot(aes(latitude, depth, z = gamma)) +
  geom_contour_filled() +
  scale_y_reverse() +
  coord_cartesian(expand = 0) +
  theme(legend.position = "top")

```

### Pacific

```{r gamma_section_WOA13_dclement_Pac}

nd_mask_tibble %>% 
  filter(longitude == Pac_lon) %>% 
  ggplot(aes(latitude, depth, z = gamma)) +
  geom_contour_filled() +
  scale_y_reverse() +
  coord_cartesian(expand = 0) +
  theme(legend.position = "top")

```


## Write file

```{r write_WOA13_dclement_file, eval=FALSE}

nd_mask_tibble %>%
  write_csv(here::here("data/World_Ocean_Atlas_2018/_summarized_files",
                       "WOA13_mask_gamma.csv"))

rm(nd_mask, nd_mask_tibble, Atl_lon, Pac_lon, depth_surface_selection)

```





# Open tasks

- apply basin mask to WOA18 data
- add Indian ocean section plot

# Questions

- Which version of the WOA to be used
  - Fields (currently: objectively analyzed mean)
  - Decades (currently: oall decades)
  - Grid (currently: o1 deg resolution)
- How to merge with GLODAP climatology (currently interpolated to GLODAP depth)
