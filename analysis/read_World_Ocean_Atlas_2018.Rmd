---
title: "World Ocean Atlas 2018"
author: "Jens Daniel Müller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

```{r library, message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(tidync)
library(stars)
```


```{r ggplot_theme, include = FALSE}
theme_set(theme_bw())
```

# Data source
- Data source: [World Ocean Atlas 2018](https://www.nodc.noaa.gov/OC5/woa18/woa18data.html)

# Basin mask

## Read data

The surface mask (0m) with 1x1° resolution from the file `basinmask_01.msk` was used.

```{r read_basin_mask}

basinmask_01 <- read_csv(here::here("data/World_Ocean_Atlas_2018",
                                    "basinmask_01.msk"),
                         skip = 1)

basinmask_01 <- basinmask_01 %>% 
  select(Latitude:Basin_0m) %>% 
  mutate(Basin_0m = as.factor(Basin_0m)) %>% 
  rename(lat = Latitude, lon = Longitude)
  
```

## Basin labels

According to [WOA FAQ](https://www.nodc.noaa.gov/OC5/WOD/wod-woa-faqs.html) website, number codes in the mask file refer to Ocean basins as follows:  

- 1: Atlantic Ocean (with 10 - Southern Ocean, between 63°W and 20°E)
- 2: Pacific Ocean (with 10 - Southern Ocean, between 147°E and 63°W)
- 3: Indian Ocean (with 10 - Southern Ocean, between 20°E and 147°E)

From this, the Atlantik and the Indo-Pacific were labeled.

```{r assign_basin_labels}

basinmask_01 <- basinmask_01 %>% 
  filter(Basin_0m %in% c("1", "2", "3", "10")) %>% 
  mutate(basin = if_else(Basin_0m == "10" & lon >= -63 & lon < 20,
                         "Atlantic", "Indo-Pacific"),
         basin = if_else(Basin_0m == "1",
                         "Atlantic", basin)) %>% 
  select(-Basin_0m)

```

## Plot world map

```{r map_basin_mask_WOA}

mapWorld <- borders("world", colour="gray60", fill="gray60")

basinmask_01 %>% 
  ggplot(aes(lon, lat, fill=basin))+
  mapWorld+
  geom_raster()+
  scale_fill_brewer(palette = "Dark2")+
  coord_quickmap(expand = 0)

```

## Write file

```{r write_basin_mask_file}

basinmask_01 %>% 
  write_csv(here::here("data/World_Ocean_Atlas_2018/_summarized_files",
                       "basin_mask_WOA18.csv"))

```


# Read/plot ncdf files

- read-in not yet started

```{r read_GLODAPv2_2016_Mappedclimatologies_netcdfs, eval=FALSE}

file_list <- list.files(path= "data/GLODAPv2_2016b_Mappedclimatologies", pattern = "*.nc")

print("files used:")
print(file_list)

#file <- file_list[1]

for (file in file_list) {
 
clim_stars <- read_stars(here::here("data/GLODAPv2_2016b_Mappedclimatologies",
                          file))

parameter <- str_split(file, pattern = "6b.", simplify = TRUE)[2]
parameter <- str_split(parameter, pattern = ".nc", simplify = TRUE)[1]

map_clim_stars <- clim_stars %>% select(all_of(parameter))

map_clim_stars <- map_clim_stars %>% 
  filter(depth_surface %in% c(0,50,100,200,500,1000,2000,3000,5000))

print(
ggplot()+
  geom_stars(data = map_clim_stars)+
  geom_vline(xintercept = 335, col="white")+
  scale_fill_viridis_b()+
  labs(title = file)+
  facet_wrap(~depth_surface, ncol = 3)+
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank())+
  coord_quickmap(expand = 0)
)


# clim_tidync <- tidync(here::here("data/GLODAPv2_2016b_Mappedclimatologies",
#                                  file))
# print(clim_tidync)
# 
# Atl_sec_clim <- clim_tidync %>% hyper_filter(lon = lon == 335.5)
# Atl_sec_clim_tibble <- Atl_sec_clim %>% hyper_tibble()
# 
# Atl_sec_clim_tibble %>% 
#   ggplot(aes(lat, depth_surface, fill=Cant))+
#   geom_point()+
#   scale_y_reverse()+
#   scale_fill_viridis_b()

}


```


# Open tasks

- none

# Questions

- none
