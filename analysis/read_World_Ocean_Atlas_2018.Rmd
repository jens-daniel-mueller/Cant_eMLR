---
title: "World Ocean Atlas 2018"
author: "Jens Daniel Müller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r library, message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(tidync)
library(stars)
```


```{r ggplot_theme, include = FALSE}
theme_set(theme_bw())
```

# Data source
- Data source: [World Ocean Atlas 2018](https://www.nodc.noaa.gov/OC5/woa18/woa18data.html){target="_blank"}

# Basin mask

## Read data

The surface mask (0m) with 1x1° resolution from the file `basinmask_01.msk` was used.

```{r read_basinmask}

basinmask_01 <- read_csv(here::here("data/World_Ocean_Atlas_2018",
                                    "basinmask_01.msk"),
                         skip = 1)

basinmask_01 <- basinmask_01 %>% 
  select(Latitude:Basin_0m) %>% 
  mutate(Basin_0m = as.factor(Basin_0m)) %>% 
  rename(lat = Latitude, lon = Longitude)
  
```

## Basin labels

According to [WOA FAQ](https://www.nodc.noaa.gov/OC5/WOD/wod-woa-faqs.html) website, number codes in the mask file refer to Ocean basins as follows:  

- 1: Atlantic Ocean (with 10 - Southern Ocean, between 63°W and 20°E)
- 2: Pacific Ocean (with 10 - Southern Ocean, between 147°E and 63°W)
- 3: Indian Ocean (with 10 - Southern Ocean, between 20°E and 147°E)

From this, the Atlantik and the Indo-Pacific were labeled.

```{r assign_basin_labels}

basinmask_01 <- basinmask_01 %>% 
  filter(Basin_0m %in% c("1", "2", "3", "10")) %>% 
  mutate(basin = if_else(Basin_0m == "10" & lon >= -63 & lon < 20,
                         "Atlantic", "Indo-Pacific"),
         basin = if_else(Basin_0m == "1",
                         "Atlantic", basin)) %>% 
  select(-Basin_0m)

```

## Plot map

```{r basinmask_WOA18_map}

mapWorld <- borders("world", col = "gray60", fill = "gray60")

basinmask_01 %>% 
  ggplot(aes(lon, lat, fill = basin)) +
  mapWorld +
  geom_raster() +
  scale_fill_brewer(palette = "Dark2") +
  coord_quickmap(expand = 0) +
  theme(legend.position = "top")

rm(mapWorld)

```

## Write file

```{r write_basinmask_file}

basinmask_01 %>% 
  write_csv(here::here("data/World_Ocean_Atlas_2018/_summarized_files",
                       "basin_mask_WOA18.csv"))

rm(basinmask_01)

```


# WOA18 data

Copied from the WOA FAQ website, the file naming conventions is:  

PREF_DDDD_VTTFFGG.EXT, where:

- PREF: prefix
- DDDD: decade
- V: variable
- TT: time period
- FF: field type
- GG: grid (5deg- 5°, 01- 1°, 04 - 1/4°)
- EXT: file extention

Short description of the statistical fields in WOA

- Objectively analyzed climatologies are the objectively interpolated mean fields for oceanographic variables at standard - depth levels for the World Ocean.
- The statistical mean is the average of all unflagged interpolated values at each standard depth level for each variable - in each 1° square which contains at least one measurement for the given oceanographic variable.
- The number of observations of each variable in each 1° square of the World Ocean at each standard depth level.
- The standard deviation about the statistical mean of each variable in each 1° square at each standard depth level.
- The standard error of the mean of each variable in each 1° square at each standard depth level.
- The seasonal or monthly climatology minus the annual climatology at each 1° square at each standard depth.
- The statistical mean minus the climatological mean at each 1° square at each standard depth. This value is used as an estimate of interpolation and smoothing error.
- The number of 1° squares within the smallest radius of influence around each 1° square which contain a statistical mean.

Here, we use  

- Fields: objectively analyzed mean
- Decades: all decades
- Grid: 1 deg resolution

## Read ncdfs

```{r read_WOA18}

# temperature

WOA_tem <- tidync(here::here("data/World_Ocean_Atlas_2018",
                                 "woa18_decav_t00_01.nc"))

WOA_tem_tibble <- WOA_tem %>% hyper_tibble()

WOA_tem_tibble <- WOA_tem_tibble  %>% 
  select(t_an, lon, lat, depth) %>% 
  drop_na()

# salinity

WOA_sal <- tidync(here::here("data/World_Ocean_Atlas_2018",
                                 "woa18_decav_s00_01.nc"))

WOA_sal_tibble <- WOA_sal %>% hyper_tibble()

WOA_sal_tibble <- WOA_sal_tibble  %>% 
  select(s_an, lon, lat, depth) %>% 
  drop_na()

```


```{r set_criteria_horizons_sections}

depth_surface_selection <- c(0)
Atl_lon <- 335.5 - 360 # subtract 360 from value used for GLODAP climatology
Pac_lon <- 190.5 - 360 # subtract 360 from value used for GLODAP climatology

```

Below, following subsets of the climatologies are plotted for all relevant parameters:  

- Horizontal planes at `r depth_surface_selection`m
- Meridional sections at longitudes:
  - Atlantic: `r Atl_lon`
  - Pacific: `r Pac_lon`

Section locations are indicated as white lines in maps.

Please note that longitudes in the climatologies range from -179.5 - 179.5, which is different from GLODAP mapped climatologies.



## Temperature plots

### Surface map

```{r temperature_surface_WOA18_map}

WOA_tem_tibble %>% 
  filter(depth == 0) %>% 
  ggplot(aes(lon, lat, fill = t_an)) +
  geom_raster() +
  geom_vline(xintercept = c(Atl_lon, Pac_lon), col = "white") +
  coord_quickmap(expand = 0) +
  scale_fill_viridis_c() +
  theme(legend.position = "top")


```

### Section

```{r temperature_section_WOA18_map}

WOA_tem_tibble %>% 
  filter(lon == Atl_lon) %>% 
  ggplot(aes(lat, depth, z = t_an)) +
  geom_contour_filled() +
  scale_y_reverse() +
  coord_cartesian(expand = 0) +
  theme(legend.position = "top")

```




## Salinity plots

### Surface map

```{r salinity_surface_WOA18_map}

WOA_sal_tibble %>% 
  filter(depth == 0) %>% 
  ggplot(aes(lon, lat, fill = s_an)) +
  geom_raster() +
  geom_vline(xintercept = c(Atl_lon, Pac_lon), col = "white") +
  coord_quickmap(expand = 0) +
  scale_fill_viridis_c() +
  theme(legend.position = "top")

```


### Section

```{r salinity_section_WOA18_map}

WOA_sal_tibble %>% 
  filter(lon == Pac_lon) %>% 
  ggplot(aes(lat, depth, z = s_an)) +
  geom_contour_filled() +
  scale_y_reverse() +
  coord_cartesian(expand = 0) +
  theme(legend.position = "top")

```


## Write file

```{r write_WOA_predictor_file}

WOA18_predictors <- full_join(WOA_sal_tibble, WOA_tem_tibble)

WOA18_predictors %>% 
  write_csv(here::here("data/World_Ocean_Atlas_2018/_summarized_files",
                       "WOA18_predictors.csv"))

rm(WOA18_predictors, WOA_sal, WOA_sal_tibble, WOA_tem, WOA_tem_tibble)

```


# Open tasks

- basin mask not yet applied to WOA18 data

# Questions

- Which version of the WOA to be used
  - Fields (currently: objectively analyzed mean)
  - Decades (currently: oall decades)
  - Grid (currently: o1 deg resolution)
- How to merge with GLODAP climatology (currently interpolated to GLODAP depth)
