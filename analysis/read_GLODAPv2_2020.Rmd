---
title: "GLODAPv2_2020"
author: "Jens Daniel Müller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r library, message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(patchwork)
library(cutr)
```

```{r ggplot_theme, include = FALSE}
theme_set(theme_bw())
```

```{r read_parameters, include = FALSE}
parameters <-
  read_rds(here::here("data",
                       "parameters.rds"))
```

```{r read_mask_files, include = FALSE}
basinmask <-
  read_csv(
    here::here(
      "data/World_Ocean_Atlas_2018/_summarized_files",
      "basin_mask_WOA18.csv"
    )
  )
landmask <-
  read_csv(
    here::here(
      "data/World_Ocean_Atlas_2018/_summarized_files",
      "land_mask_WOA18.csv"
    )
  )
```


# Read files

Main data source for this project is `GLODAPv2.2020_Merged_Master_File.csv` downloaded from [glodap.info](https://www.glodap.info/) in June 2020.

```{r read_GLODAPv2_2020_merged_master_file}


GLODAP <-
  read_csv(
    here::here(
      "data/GLODAPv2_2020/Merged_data_product",
      "GLODAPv2.2020_Merged_Master_File.csv"
    ),
    na = "-9999",
    col_types = cols(.default = col_double())
  )

# select relevant columns
GLODAP <- GLODAP %>%
  select(cruise:talkqc)

# create date column
GLODAP <- GLODAP %>%
  mutate(date = ymd(paste(year, month, day))) %>%
  #decade = as.factor(floor(year / 10) * 10)) %>%
  relocate(date)

# harmonize column names
GLODAP <- GLODAP  %>%
  rename(sal = salinity,
         tem = temperature)

# harmonize coordinates
GLODAP <- GLODAP  %>%
  rename(lon = longitude,
         lat = latitude) %>%
  mutate(lon = if_else(lon < 20, lon + 360, lon))

# remove irrelevant columns
GLODAP <- GLODAP %>%
  select(-c(month:minute,
            maxsampdepth, sigma0:sigma4,
            nitrite:nitritef))

```

# Data preparation

## Flags and missing data

Only rows (samples) for which all relevant parameters are available were selected.
In additions, following flagging criteria were applied:

- flag_f:     `r parameters$flag_f`
- flag_qc:    `r parameters$flag_qc`
  
Summary statistics were calculated during cleaning process.

```{r clean_GLODAP_master_file}

GLODAP_stats <- GLODAP %>% 
  summarise(total = n())

##

GLODAP <- GLODAP %>% 
  filter(!is.na(tco2))

GLODAP <- GLODAP %>% 
  filter(tco2f == parameters$flag_f) %>% 
  select(-tco2f)

GLODAP <- GLODAP %>% 
  filter(tco2qc == parameters$flag_qc) %>% 
  select(-tco2qc)

GLODAP_stats_temp <- GLODAP %>% 
  summarise(tco2 = n())

GLODAP_stats <- cbind(GLODAP_stats, GLODAP_stats_temp)
rm(GLODAP_stats_temp)

##

GLODAP <- GLODAP %>% 
  filter(!is.na(talk))

GLODAP <- GLODAP %>% 
  filter(talkf == parameters$flag_f) %>% 
  select(-talkf)

GLODAP <- GLODAP %>% 
  filter(talkqc == parameters$flag_qc) %>% 
  select(-talkqc)

##

GLODAP <- GLODAP %>% 
  filter(!is.na(phosphate))

GLODAP <- GLODAP %>% 
  filter(phosphatef == parameters$flag_f) %>% 
  select(-phosphatef)

GLODAP <- GLODAP %>% 
  filter(phosphateqc == parameters$flag_qc) %>% 
  select(-phosphateqc)

GLODAP_stats_temp <- GLODAP %>% 
  summarise(C_star_variables = n())

GLODAP_stats <- cbind(GLODAP_stats, GLODAP_stats_temp)
rm(GLODAP_stats_temp)

##

GLODAP <- GLODAP %>% 
  filter(!is.na(tem))

##
  
GLODAP <- GLODAP %>% 
  filter(!is.na(sal))

GLODAP <- GLODAP %>% 
  filter(salinityf == parameters$flag_f) %>% 
  select(-salinityf)

GLODAP <- GLODAP %>% 
  filter(salinityqc == parameters$flag_qc) %>% 
  select(-salinityqc)

##
  
GLODAP <- GLODAP %>% 
  filter(!is.na(silicate))

GLODAP <- GLODAP %>% 
  filter(silicatef == parameters$flag_f) %>% 
  select(-silicatef)

GLODAP <- GLODAP %>% 
  filter(silicateqc == parameters$flag_qc) %>% 
  select(-silicateqc)

##
  
GLODAP <- GLODAP %>% 
  filter(!is.na(oxygen))

GLODAP <- GLODAP %>% 
  filter(oxygenf == parameters$flag_f) %>% 
  select(-oxygenf)

GLODAP <- GLODAP %>% 
  filter(oxygenqc == parameters$flag_qc) %>% 
  select(-oxygenqc)

##

GLODAP <- GLODAP %>% 
  filter(!is.na(aou))

GLODAP <- GLODAP %>% 
  filter(aouf == parameters$flag_f) %>% 
  select(-aouf)

##
  
GLODAP <- GLODAP %>% 
  filter(!is.na(nitrate))

GLODAP <- GLODAP %>% 
  filter(nitratef == parameters$flag_f) %>% 
  select(-nitratef)

GLODAP <- GLODAP %>% 
  filter(nitrateqc == parameters$flag_qc) %>% 
  select(-nitrateqc)

##

GLODAP <- GLODAP %>% 
  filter(!is.na(depth))

GLODAP <- GLODAP %>% 
  filter(!is.na(gamma))

##

GLODAP_stats_temp <- GLODAP %>% 
  summarise(eMLR_variables = n())

GLODAP_stats <- cbind(GLODAP_stats, GLODAP_stats_temp)

rm(GLODAP_stats_temp)

```

## Spatial boundaries

Only observations were taken into consideration with:

- minimum sampling depth:  `r parameters$depth_min`m
- minimum bottom depth:  `r parameters$bottomdepth_min`m
- maximum latitude:  `r parameters$lat_max`°N


```{r apply_spatial_boundaries}

GLODAP <- GLODAP %>% 
  filter(depth >= parameters$depth_min)

GLODAP_stats_temp <- GLODAP %>% 
  summarise(eMLR_variables_150m = n())

GLODAP_stats <- cbind(GLODAP_stats, GLODAP_stats_temp)
rm(GLODAP_stats_temp)

##

GLODAP <- GLODAP %>% 
  filter(lat <= parameters$lat_max)

GLODAP <- GLODAP %>% 
  filter(bottomdepth >= parameters$bottomdepth_min)

GLODAP_stats_temp <- GLODAP %>% 
  summarise(eMLR_variables_150m_65N_500m = n())

GLODAP_stats <- cbind(GLODAP_stats, GLODAP_stats_temp)
rm(GLODAP_stats_temp)


GLODAP_stats_long <- GLODAP_stats %>% 
  pivot_longer(1:length(GLODAP_stats),
               names_to = "parameter",
               values_to = "n")

GLODAP_stats_long  %>%  write_csv(here::here("data/GLODAPv2_2020/_summarized_data_files",
                                             "GLODAPv2.2020_stats.csv"))

rm(GLODAP_stats_long, GLODAP_stats)

```

## Horizontal gridding

For merging with other data sets, all observations were grouped into latitude intervals of:

- 1° x 1°

```{r grid_spatially_1x1}

GLODAP <- GLODAP %>% 
  mutate(lat = cut(lat, seq(-90, 90, 1), seq(-89.5, 89.5, 1)),
         lat = as.numeric(as.character(lat)),
         lon = cut(lon, seq(20, 380, 1), seq(20.5, 379.5, 1)),
         lon = as.numeric(as.character(lon))) %>% 
  arrange(date)

```


## Basin mask

The basin mask from the World Ocean Atlas was used. For details consult the data base subsection for [WOA18](https://jens-daniel-mueller.github.io/Cant_eMLR/read_World_Ocean_Atlas_2018.html) data.

```{r WOA_basin_mask_GLODAP_observations_map}

GLODAP_obs <- GLODAP %>% 
  group_by(lat, lon) %>% 
  summarise(n = n()) %>% 
  ungroup()

ggplot() +
  geom_raster(data = landmask %>% filter(region == "land"),
              aes(lon, lat), fill = "grey80") +
  geom_raster(data = basinmask, aes(lon, lat, fill = basin)) +
  geom_raster(data = GLODAP_obs, aes(lon, lat)) +
  scale_fill_brewer(palette = "Dark2") +
  coord_quickmap(expand = 0) +
  theme(legend.position = "top",
        legend.title = element_blank())

rm(GLODAP_obs)

```

Please note that some GLODAP observations were made outside the WOA18 basin mask and will be removed for further analysis (eg North Sea, Sea of Japan).

```{r join_basin_mask}

GLODAP <- inner_join(GLODAP, basinmask)
rm(basinmask)

```

## Reference eras

Samples were assigned to following eras:

- JGOFS_WOCE:
`r parameters$year_JGOFS_start` - `r parameters$year_JGOFS_end`

- GO_SHIP:
`r parameters$year_JGOFS_end+1` - `r parameters$year_GOSHIP_end`

- new_era:    > `r parameters$year_GOSHIP_end+1`


```{r assign_eras}

GLODAP <- GLODAP %>%
  filter(year >= parameters$year_JGOFS_start) %>% 
  mutate(era = "JGOFS_WOCE",
         era = if_else(year > parameters$year_JGOFS_end, "GO_SHIP", era),
         era = if_else(year > parameters$year_GOSHIP_end, "new_era", era))

```

### Manual adjustment A16 cruise

For harmonization with Gruber et al. (2019), cruises 1041 (A16N) and 1042 (A16S) were grouped into the GO_SHIP area despite taking place in 2013/14.

```{r GLODAP_Atl_cruises_2013_2014_map}

GLODAP_cruises <- GLODAP %>% 
  filter(basin == "Atlantic",
         year %in% c(2013, 2014)) %>% 
  group_by(lat, lon, cruise) %>% 
  summarise(cruise = as.factor(mean(cruise))) %>% 
  ungroup()

ggplot() +
  geom_raster(data = landmask %>% filter(region == "land"),
              aes(lon, lat), fill = "grey80") +
  geom_raster(data = GLODAP_cruises, aes(lon, lat, fill = cruise)) +
  scale_fill_brewer(palette = "Dark2") +
  coord_quickmap(expand = 0) +
  theme(legend.position = "top",
        legend.title = element_blank())

rm(GLODAP_cruises)

```


```{r switch_eras_manually}

GLODAP <- GLODAP %>%
  mutate(era = if_else(cruise %in% c(1041, 1042),
                       "GO_SHIP", era))

```


## Observations grid

A 1x1 grid containing all coordinates with at least one GLODAP observation was created.

```{r GLODAP_clean_observations_grid}

GLODAP_obs_grid <- GLODAP %>% 
  group_by(lat, lon) %>% 
  summarise(n = n()) %>% 
  ungroup()

```


## Write summary file
 
```{r write_clean_data_files}

GLODAP_obs_grid  %>%  write_csv(here::here("data/GLODAPv2_2020/_summarized_data_files",
                                           "GLODAPv2.2020_clean_obs_grid.csv"))

GLODAP  %>%  write_csv(here::here("data/GLODAPv2_2020/_summarized_data_files",
                                  "GLODAPv2.2020_clean.csv"))

rm(GLODAP, GLODAP_obs_grid)

```


# Overview plots

## Cleaning stats

Number of observations at various steps of data cleaning.

```{r GLODAP_cleaning_stats}

GLODAP_stats_long <-  read_csv(here::here("data/GLODAPv2_2020/_summarized_data_files",
                                             "GLODAPv2.2020_stats.csv"))

GLODAP_stats_long <- GLODAP_stats_long %>%
  mutate(parameter = fct_reorder(parameter, n))

GLODAP_stats_long %>% 
  ggplot(aes(parameter, n/1000)) +
  geom_col() +
  coord_flip() +
  labs(y = "n (1000)") +
  theme(axis.title.y = element_blank())

rm(GLODAP_stats_long)

```


## Assign coarse spatial grid

For the following plots, the cleaned data set was re-opened and observations were gridded spatially to intervals of:  

- 5° x 5°


```{r read_GLODAP_clean}

GLODAP <- read_csv(here::here("data/GLODAPv2_2020/_summarized_data_files",
                              "GLODAPv2.2020_clean.csv"))

```

```{r grid_spatially_coarse}


GLODAP <- GLODAP %>%
  mutate(
    lat_grid = smart_cut(
      lat,
      seq(-90, 90, parameters$coarse_grid_resolution),
      labels = ~ mean(.y)
    ),
    lat_grid = as.numeric(as.character(lat_grid)),
    lon_grid = smart_cut(
      lon,
      seq(-1000, 1000, parameters$coarse_grid_resolution),
      labels = ~ mean(.y)
    ),
    lon_grid = as.numeric(as.character(lon_grid))
  ) %>%
  arrange(date)

```


```{r grid_spatially_5x5}

GLODAP <- GLODAP %>% 
  mutate(lat_grid = cut(lat, seq(-90, 90, 5), seq(-87.5, 87.5, 5)),
         lat_grid = as.numeric(as.character(lat_grid)),
         lon_grid = cut(lon, seq(20, 380, 5), seq(22.5, 377.5, 5)),
         lon_grid = as.numeric(as.character(lon_grid))) %>% 
  arrange(date)

```


## Histogram Zonal coverage

```{r coverage_histogram_zonal}

GLODAP_histogram_lat <- GLODAP %>%
  group_by(era, lat_grid, basin) %>%
  tally() %>%
  ungroup()

GLODAP_histogram_lat %>%
  ggplot(aes(lat_grid, n, fill = era)) +
  geom_col() +
  scale_fill_brewer(palette = "Dark2") +
  facet_wrap( ~ basin) +
  coord_flip(expand = 0) +
  theme(legend.position = "top",
        legend.title = element_blank())

rm(GLODAP_histogram_lat)

```

## Histogram temporal coverage

```{r coverage_histogram_temporal}

GLODAP_histogram_year <- GLODAP %>%
  group_by(year, basin) %>%
  tally() %>%
  ungroup()

era_median_year <- GLODAP %>%
  group_by(era) %>%
  summarise(t_ref = median(year)) %>%
  ungroup()

GLODAP_histogram_year %>%
  ggplot() +
  geom_vline(xintercept = c(
    parameters$year_JGOFS_end + 0.5,
    parameters$year_GOSHIP_end + 0.5
  )) +
  geom_col(aes(year, n, fill = basin)) +
  geom_point(
    data = era_median_year,
    aes(t_ref, 0, shape = "Median year"),
    size = 2,
    fill = "white"
  ) +
  scale_fill_brewer(palette = "Dark2") +
  scale_shape_manual(values = 24, name = "") +
  scale_y_continuous() +
  coord_cartesian(expand = 0) +
  theme(
    legend.position = "top",
    legend.direction = "vertical",
    legend.title = element_blank(),
    axis.title.x = element_blank()
  )

rm(GLODAP_histogram_year,
   era_median_year)

```

## Zonal temporal coverage (Hovmoeller)

```{r coverage_hovmoeller, fig.asp=1}

GLODAP_hovmoeller_year <- GLODAP %>%
  group_by(year, lat_grid, basin) %>%
  tally() %>%
  ungroup()

GLODAP_hovmoeller_year %>%
  ggplot(aes(year, lat_grid, fill = log10(n))) +
  geom_tile() +
  geom_vline(xintercept = c(1999.5, 2012.5)) +
  scale_fill_viridis_c(option = "magma", direction = -1) +
  facet_wrap( ~ basin, ncol = 1) +
  theme(legend.position = "top",
        axis.title.x = element_blank())

rm(GLODAP_hovmoeller_year)

```

## Coverage maps by era

```{r coverage_maps_era, fig.asp=1.5}

GLODAP <- GLODAP %>% 
  mutate(era = factor(era, c("JGOFS_WOCE", "GO_SHIP", "new_era")))

GLODAP %>%
  ggplot(aes(lon, lat)) +
  geom_raster(data = landmask %>% filter(region == "land"),
              aes(lon, lat), fill = "grey80") +
  geom_bin2d(binwidth = c(1,1)) +
  scale_fill_viridis_c(option = "magma", direction = -1, trans = "log10",
                       name = "log10(n)") +
  coord_quickmap(expand = FALSE) +
  facet_wrap(~era, ncol = 1) +
  theme(legend.position = "top",
        axis.title = element_blank())

```

# Individual cruise sections

Zonal and meridional section plots are produce for each cruise individually and can be downloaded [here](https://github.com/jens-daniel-mueller/Cant_eMLR/tree/master/output/figure/data/all_cruises_clean){target="_blank"}.

```{r individual_cruises_clean_triplicates, eval = FALSE}


cruises <- GLODAP %>% 
  group_by(cruise) %>% 
  summarise(date_mean = mean(date, na.rm = TRUE),
            n = n()) %>% 
  ungroup() %>% 
  arrange(date_mean)

GLODAP <- full_join(GLODAP, cruises)

n <- 0
for (i_cruise in unique(cruises$cruise)) {

# i_cruise <- unique(cruises$cruise)[1]
n <- n+1
print(n)  
  
GLODAP_cruise <- GLODAP %>%
  filter(cruise == i_cruise) %>% 
  arrange(date)

cruises_cruise <- cruises %>%
  filter(cruise == i_cruise)
  
map <- GLODAP_cruise %>%
  ggplot(aes(lon, lat)) +
  geom_raster(data = landmask %>% filter(region == "land"),
              aes(lon, lat), fill = "grey80") +
  geom_point(aes(col=date)) +
  coord_quickmap(expand = FALSE) +
  scale_color_viridis_c(trans = "date") +
  labs(title = paste("Mean date:", cruises_cruise$date_mean,
                     "| cruise:", cruises_cruise$cruise,
                     "| n(samples):", cruises_cruise$n))


lon_section <- GLODAP_cruise %>%
  ggplot(aes(lon, depth)) +
  scale_y_reverse() +
  scale_color_viridis_c()

lon_tco2 <- lon_section+
  geom_point(aes(col=tco2))

lon_talk <- lon_section+
  geom_point(aes(col=talk))

lon_phosphate <- lon_section+
  geom_point(aes(col=phosphate))


lat_section <- GLODAP_cruise %>%
  ggplot(aes(lat, depth)) +
  scale_y_reverse() +
  scale_color_viridis_c()

lat_tco2 <- lat_section+
  geom_point(aes(col=tco2))

lat_talk <- lat_section+
  geom_point(aes(col=talk))

lat_phosphate <- lat_section+
  geom_point(aes(col=phosphate))

map /
((lat_tco2 / lat_talk / lat_phosphate) |
(lon_tco2 / lon_talk / lon_phosphate))

ggsave(here::here("output/figure/data/all_cruises_clean",
                  paste("GLODAP_cruise_date",
                        cruises_cruise$date_mean,
                        "n",
                        cruises_cruise$n,
                        "cruise",
                        cruises_cruise$cruise,
                        ".png",
                        sep = "_")),
                  width = 9, height = 9)

rm(map,
   lon_section, lat_section,
   lat_tco2, lat_talk, lat_phosphate, lon_tco2, lon_talk, lon_phosphate,
   GLODAP_cruise, cruises_cruise)

}


```

```{r map_projection, eval=FALSE}


# library("rnaturalearth")
# library("rnaturalearthdata")
# library("sf")
# 
# world <- ne_countries(scale = "small", returnclass = "sf")
# class(world)
# 
# GLODAP_map <- GLODAP %>% 
#   group_by(lat_grid, lon_grid) %>% 
#   tally() %>% 
#   ungroup()
# 
# ggplot() +
#   geom_raster(data = GLODAP_map, aes(lon_grid, lat_grid)) +
#   geom_sf(data = world) +
#   coord_sf(crs = "+proj=robin +lat_0=0 +lon_0=0 +x0=0 +y0=0")


# https://gist.github.com/clauswilke/783e1a8ee3233775c9c3b8bfe531e28a
# https://twitter.com/clauswilke/status/1066024436208406529
# https://www.r-spatial.org/r/2018/10/25/ggplot2-sf.html

```



# Open tasks

- move A16 cruises in 2013 from new_era to GO_SHIP era

# Questions

- Apply coastal filter?
- Keep horizontal gridding to 1°x1° (thereby discarding some horizontal information)?
- Quality of WOA18 basin mask
  - excluded areas (e.g. Bay of Bengal, South Norwegian Sea, Sea of Japan)
  - Pacific-Atlantic boundary
