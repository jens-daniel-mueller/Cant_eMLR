---
title: "Anthropogenic CO2 from 1994 to 2007"
author: "Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r library, message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(tidync)
library(stars)
```


```{r read_parameters, include = FALSE}
parameters <-
  read_rds(here::here("data",
                       "parameters.rds"))
```

```{r read_mask_files, include = FALSE}
basinmask <-
  read_csv(
    here::here(
      "data/World_Ocean_Atlas_2018/_summarized_files",
      "basin_mask_WOA18.csv"
    )
  )
landmask <-
  read_csv(
    here::here(
      "data/World_Ocean_Atlas_2018/_summarized_files",
      "land_mask_WOA18.csv"
    )
  )
```

```{r read_functions, include = FALSE}
source(here::here("code", "plotting_functions.R"))
```

```{r ggplot_theme, include = FALSE}
theme_set(theme_bw())
```

# Data source

- Anthropogenic CO2 estimates (1994-2007) by Gruber et al. (2019) downloaded in August 2020 from [NOAA/NCEI Ocean Carbon Data System (OCADS)](https://www.nodc.noaa.gov/ocads/oceans/ndp_100/ndp100.html){target="_blank"}

# Read ncdfs

```{r read_Gruber_dcant}

dcant <- tidync(here::here("data/Gruber_2019",
                               "dcant_emlr_cstar_gruber_94-07_vs1.nc"))

dcant <- dcant %>%  activate(DCANT_01)
dcant <- dcant %>% hyper_tibble()

# harmonize column names and coordinates
dcant <- dcant %>% 
  rename(lon = LONGITUDE,
         lat = LATITUDE,
         depth = DEPTH,
         cant = DCANT_01) %>% 
  mutate(lon = if_else(lon < 20, lon + 360, lon))

```

```{r read_Gruber_dcant_inv}

dcant_inv <- tidync(here::here("data/Gruber_2019",
                               "inv_dcant_emlr_cstar_gruber_94-07_vs1.nc"))

dcant_inv <- dcant_inv %>%  activate(DCANT_INV01)
dcant_inv <- dcant_inv %>% hyper_tibble()

# harmonize column names and coordinates
dcant_inv <- dcant_inv %>% 
  rename(lon = LONGITUDE,
         lat = LATITUDE,
         cant_inv = DCANT_INV01) %>% 
  mutate(lon = if_else(lon < 20, lon + 360, lon))

```

# Apply basin mask

```{r apply_basin_mask}

dcant <- inner_join(dcant, basinmask)
dcant_inv <- inner_join(dcant_inv, basinmask)

```


# Cant plots

Below, following subsets of the climatologies are plotted for all relevant parameters:  

- Horizontal planes at `r parameters$depth_levels`m
- Meridional sections at longitudes: `r parameters$longitude_sections_basin`

Section locations are indicated as white lines in maps.


## Horizontal plane maps

```{r Cant_maps, fig.asp=0.6}

map_climatology(dcant %>% filter(cant < 25), "cant")

```

## Surface Inventory map

```{r Cant_inv_map, fig.asp=0.6}

map_climatology_inv(dcant_inv, "cant_inv")

```

## Sections

```{r Cant_sections, fig.asp=1}

section_climatology(dcant, "cant")

```

## Sections shallow

```{r Cant_sections_shallow, fig.asp=1}

section_climatology_shallow(dcant, "cant")

```

# Write files

```{r write_Gruber_Cant_file}

dcant %>% 
  write_csv(here::here("data/Gruber_2019/_summarized_files",
                       "Cant_07.csv"))

dcant_inv %>% 
  write_csv(here::here("data/Gruber_2019/_summarized_files",
                       "Cant_07_inv.csv"))

```



# Open tasks

- 

# Questions

- Why are there no negative Cant estimates?
