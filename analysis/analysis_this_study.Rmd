---
title: "Analysis of Cant estimates"
author: "Jens Daniel Müller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r library, message=FALSE, warning=FALSE}
library(tidyverse)
library(patchwork)
library(scico)
library(scales)
library(metR)
```


```{r read_parameters, include = FALSE}
parameters <-
  read_rds(here::here("data",
                       "parameters.rds"))

slab_breaks <- c(parameters$slabs_Atl[1:12],Inf)
```

```{r read_mask_files, include = FALSE}
basinmask <-
  read_csv(
    here::here(
      "data/World_Ocean_Atlas_2018/_summarized_files",
      "basin_mask_WOA18.csv"
    )
  )
landmask <-
  read_csv(
    here::here(
      "data/World_Ocean_Atlas_2018/_summarized_files",
      "land_mask_WOA18.csv"
    )
  )

section_global_coordinates <-
  read_csv(here::here("data",
                       "section_global_coordinates.csv"))
```

```{r read_functions, include = FALSE}
source(here::here("code", "plotting_functions.R"))
```

```{r ggplot_theme, include = FALSE}
theme_set(theme_bw())
```

# Data sources

Cant estimates from this study:

- Mean and SD per grid cell (lat, lon, depth)
- Zonal mean and SD (basin, lat, depth)
- Inventories (lat, lon)


```{r read_cant_files}


Cant_average <-
  read_csv(here::here("data/mapping/_summarized_files",
                         "Cant_average.csv"))

Cant_average_zonal <-
  read_csv(here::here("data/mapping/_summarized_files",
                         "Cant_average_zonal.csv"))

Cant_predictor_average_zonal <-
  read_csv(here::here("data/mapping/_summarized_files",
                         "Cant_predictor_average_zonal.csv"))

Cant_inv <-
  read_csv(here::here("data/mapping/_summarized_files",
                         "Cant_inv.csv"))

```

C* estimates from this study:

- Mean and SD per grid cell (lat, lon, depth)
- Zonal mean and SD (basin, lat, depth)

```{r read_cstar_files}


Cstar_average <-
  read_csv(here::here("data/mapping/_summarized_files",
                         "Cstar_average.csv"))

Cstar_average_zonal <-
  read_csv(here::here("data/mapping/_summarized_files",
                         "Cstar_average_zonal.csv"))


```

Cleaned GLODAPv2_2020 file as used in this study

```{r read_GLODAP_used_for_fitting}

GLODAP <-
  read_csv(
    here::here(
      "data/GLODAPv2_2020/_summarized_data_files",
      "GLODAP_MLR_fitting_ready.csv"
    )
  )

```


# Neutral density

## Slab depth

Please note that:

- density slabs covering values >28.1 occur by definition only either in the Atlantic or Indo-Pacific basin
- predictor density slabs are only shown for the upper `r parameters$inventory_depth`m as used for the mapping, whereas GLODAP observations are displayed for the entire water column as used for fitting eMLRs (in both cases shallow waters are excluded at low density)

```{r gamma_maps, fig.asp=2}

gamma_maps <- Cant_average %>% 
  group_by(lat, lon, gamma_slab) %>% 
  summarise(depth_max = max(depth, na.rm = TRUE)) %>% 
  ungroup()

GLODAP_obs_coverage <- GLODAP %>% 
  count(lat, lon, gamma_slab, era)
  

ggplot() +
  geom_raster(data = landmask,
              aes(lon, lat),
              fill = "grey80") +
  geom_raster(data = gamma_maps,
              aes(lon, lat, fill = depth_max)) +
  geom_raster(data = GLODAP_obs_coverage,
              aes(lon, lat), fill = "red") +
  facet_grid(gamma_slab ~ era) +
  coord_quickmap(expand = 0) +
  scale_fill_viridis_c(direction = -1) +
  theme(axis.title = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        legend.position = "top")

rm(gamma_maps, GLODAP_obs_coverage)
```

## Surface maps

```{r gamma_surface_map}

map_climatology(Cant_average, "gamma")

```


## Zonal sections

The mean zonal distribution of neutral densities was calculated. **CAVEAT:** Due to practical reasons, binning here does not include the two highest isoneutral density slabs in the Atlantic, yet.

### Mean

```{r gamma_sections_mean}

Cant_average_zonal %>% 
  filter(eras == "JGOFS_GO") %>% 
  ggplot(aes(lat, depth, z = gamma_mean)) +
  geom_contour_filled(breaks = slab_breaks) +
  geom_contour(breaks = slab_breaks,
               col = "white") +
  geom_text_contour(breaks = slab_breaks,
               col = "white",
               skip = 1) +
  scale_fill_viridis_d(name = "Gamma",
                       direction = -1) +
  scale_y_reverse() +
  scale_x_continuous(breaks = seq(-100, 100, 20)) +
  coord_cartesian(expand = 0) +
  guides(fill = guide_colorsteps(barheight = unit(10, "cm"))) +
  facet_grid(basin_AIP~.)

```

### SD

Higher SD of gamma in shallow, subtropical waters results from a more pronounced longitudinal variability.

```{r gamma_sections_sd}

Cant_average_zonal %>% 
  filter(eras == "JGOFS_GO") %>% 
  ggplot(aes(lat, depth, z = gamma_sd)) +
  geom_contour_filled() +
  scale_fill_viridis_d(name = "Gamma SD",
                       direction = -1) +
  scale_y_reverse() +
  scale_x_continuous(breaks = seq(-100, 100, 20)) +
  coord_cartesian(expand = 0) +
  guides(fill = guide_colorsteps(barheight = unit(10, "cm"))) +
  facet_grid(basin_AIP~.)

```


# Cant

## Zonal sections 

### Mean

```{r Cant_sections_mean}

section_zonal_average_divergent(Cant_average_zonal,
                                "Cant_mean",
                                "gamma_mean")

```

### Mean positive values

```{r Cant_sections_positive_mean}

section_zonal_average_continous(Cant_average_zonal,
                                "Cant_pos_mean",
                                "gamma_mean")

```


### Mean standard deviation across MLR models

Standard deviation across Cant from all MLR models was calculate for each grid cell (XYZ). The zonal mean of this standard deviation should reflect the uncertainty associated to the predictor selection within each slab and era. 

```{r Cant_sections_sd_models}

section_zonal_average_continous(Cant_average_zonal,
                                "Cant_sd_mean",
                                "gamma_mean")

```

### Standard deviation across basin

Standard deviation of mean Cant values was calculate across all longitudes. This standard deviation should reflect the zonal variability of Cant within the basin and era.

```{r Cant_sections_sd_Cant}

section_zonal_average_continous(Cant_average_zonal,
                                "Cant_sd",
                                "gamma_mean")

```

### Predictor contribution

```{r Cant_section_predictor_contribution}

for (variable in c(
  "Cant_intercept",
  "Cant_aou",
  "Cant_oxygen",
  "Cant_phosphate",
  "Cant_phosphate_star",
  "Cant_silicate",
  "Cant_tem",
  "Cant_sal")) {

print(
section_zonal_average_continous(Cant_predictor_average_zonal,
                                variable,
                                "gamma")
)
    
}


rm(variable)
```


## Sections along path

### JGOFS_GO

```{r Cant_sections_positive_mean_one_lon_JGOFS_GO}

section_global(Cant_average %>% filter(eras == "JGOFS_GO"),
                    "Cant")

```

### GO_new

```{r Cant_sections_positive_mean_one_lon_GO_new}

section_global(Cant_average %>% filter(eras == "GO_new"),
                    "Cant")

```


## Sections by model

Zonal sections plots are produced for every 20° longitude, each era and for all models individually and can be downloaded [here](https://github.com/jens-daniel-mueller/Cant_eMLR/tree/master/output/figure/mapping){target="_blank"}.

## Maps

### Surfaces

Cant concentration for selected depth levels at which mapping was performed.

```{r Cant_depth_layer_maps, fig.asp=1}

Cant_average %>%
  filter(depth %in% parameters$depth_levels) %>%
  ggplot(aes(lon, lat, fill = Cant)) +
  geom_raster(data = landmask,
              aes(lon, lat), fill = "grey80") +
  geom_raster() +
  scale_fill_divergent(guide = "colorstrip",
                       breaks = MakeBreaks(5),
                       name = "Cant") +
  guides(fill = guide_colorsteps(barheight = unit(10, "cm"))) +
  coord_quickmap(expand = 0) +
  facet_grid(depth ~ eras)

```


### Distribution along slab


```{r Cant_gamma_slab_maps, fig.asp=2}

Cant_gamma_maps <- Cant_average %>% 
  group_by(lat, lon, gamma_slab, eras) %>% 
  summarise(Cant = mean(Cant, na.rm = TRUE)) %>% 
  ungroup()


ggplot() +
  geom_raster(data = landmask,
              aes(lon, lat),
              fill = "grey80") +
  geom_raster(data = Cant_gamma_maps,
              aes(lon, lat, fill = Cant)) +
  facet_grid(gamma_slab ~ eras) +
  coord_quickmap(expand = 0) +
  scale_fill_viridis_c(direction = -1) +
  theme(axis.title = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        legend.position = "top")

rm(Cant_gamma_maps)
```

```{r Cant_pos_gamma_slab_maps, fig.asp=2}

Cant_gamma_maps <- Cant_average %>% 
  group_by(lat, lon, gamma_slab, eras) %>% 
  summarise(Cant_pos = mean(Cant_pos, na.rm = TRUE)) %>% 
  ungroup()


ggplot() +
  geom_raster(data = landmask,
              aes(lon, lat),
              fill = "grey80") +
  geom_raster(data = Cant_gamma_maps %>% filter(Cant_pos <= 20),
              aes(lon, lat, fill = Cant_pos)) +
  scale_fill_gradientn(colours = c("white","blue","red","yellow")) +
  facet_grid(gamma_slab ~ eras) +
  coord_quickmap(expand = 0) +
  theme(axis.title = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        legend.position = "top")

rm(Cant_gamma_maps)
```



### Inventories

#### All Cant

```{r Cant_inventory_map, fig.asp=1}

Cant_inv %>% 
  ggplot() +
    geom_raster(data = landmask,
                aes(lon, lat), fill = "grey80") +
    geom_raster(aes(lon, lat, fill = cant_inv)) +
    coord_quickmap(expand = 0) +
    scale_fill_gradient2(high = muted("red"),
                         mid = "white",
                         low = muted("blue"),
                         midpoint = 0,
                         space = "Lab",
                         na.value = "green") +
  facet_wrap(~eras, ncol = 1) +
    theme(
      axis.title = element_blank()
    )

```


#### Positive Cant

```{r Cant_pos_inventory_map, fig.asp=1}

Cant_inv %>% 
  ggplot() +
    geom_raster(data = landmask,
                aes(lon, lat), fill = "grey80") +
    geom_raster(aes(lon, lat, fill = cant_inv_pos)) +
    coord_quickmap(expand = 0) +
    scale_fill_viridis_c() +
  facet_wrap(~eras, ncol = 1) +
    theme(
      axis.title = element_blank()
    )

```


## Cant vs model SD

```{r Cant_vs_sd_by_basin_era}

Cant_average %>% 
  ggplot(aes(Cant, Cant_sd)) +
  geom_vline(xintercept = 0) +
  geom_hline(yintercept = 10) +
  geom_bin2d() +
  scale_fill_viridis_c(option = "magma",
                       direction = -1,
                       trans = "log10",
                       name = "log10(n)") +
  facet_grid(basin_AIP ~ eras)

```

```{r Cant_vs_sd_by_basin_gamma, fig.asp=2}

Cant_average %>% 
  ggplot(aes(Cant, Cant_sd)) +
  geom_vline(xintercept = 0) +
  geom_hline(yintercept = 10) +
  geom_bin2d() +
  scale_fill_viridis_c(option = "magma",
                       direction = -1,
                       trans = "log10",
                       name = "log10(n)") +
  facet_grid(gamma_slab ~ basin_AIP)

```

## Cant vs regional SD

```{r Cant_vs_sd_by_basin_era_zonal}

Cant_average_zonal %>% 
  ggplot(aes(Cant_mean, Cant_sd)) +
  geom_vline(xintercept = 0) +
  geom_hline(yintercept = 10) +
  geom_bin2d() +
  scale_fill_viridis_c(option = "magma",
                       direction = -1,
                       trans = "log10",
                       name = "log10(n)") +
  facet_grid(basin_AIP ~ eras)

```

```{r Cant_vs_sd_by_basin_gamma_zonal, fig.asp=2}

Cant_average_zonal %>% 
  ggplot(aes(Cant_mean, Cant_sd)) +
  geom_vline(xintercept = 0) +
  geom_hline(yintercept = 10) +
  geom_bin2d() +
  scale_fill_viridis_c(option = "magma",
                       direction = -1,
                       trans = "log10",
                       name = "log10(n)") +
  facet_grid(gamma_slab ~ basin_AIP)

```

# Cstar

```{r Cstar_zonal_mean_era}

Cstar_average_zonal <- Cstar_average_zonal %>% 
    mutate(era = factor(era, c("JGOFS_WOCE", "GO_SHIP", "new_era"))) 

Cstar_average_zonal %>% 
    ggplot(aes(lat, depth, z = Cstar_mean_mean)) +
    geom_contour_filled(bins = 11) +
    scale_fill_viridis_d(name = "Cstar") +
    geom_contour(aes(lat, depth, z = gamma_mean_mean),
                 breaks = slab_breaks,
                 col = "white") +
    geom_text_contour(
      aes(lat, depth, z = gamma_mean_mean),
      breaks = slab_breaks,
      col = "white",
      skip = 1
    ) +
    scale_y_reverse() +
    coord_cartesian(expand = 0) +
    guides(fill = guide_colorsteps(barheight = unit(10, "cm"))) +
    facet_grid(basin_AIP ~ era)



```



