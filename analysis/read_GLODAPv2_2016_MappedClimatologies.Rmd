---
title: "GLODAPv2_2016: Mapped Climatologies"
author: "Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r library, message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(stars)
library(metR)
library(patchwork)
```


```{r ggplot_theme, include = FALSE}
theme_set(theme_bw())
```

# Read source files

Data source: Globally mapped climatologies from Lauvset et al. (2016) downloaded in June 2020 from [glodap.info](https://www.glodap.info/).

Following files were used: 

```{r GLODAPv2_2016_Mappedclimatologies_file_list}

file_list <- list.files(path = "data/GLODAPv2_2016b_Mappedclimatologies", pattern = "*.nc")
print(file_list)

```

# Plot data and write csv

```{r set_criteria_horizons_sections}

depth_surface_selection <- c(0,100,500,2000)
Atl_lon <- 335.5
Pac_lon <- 190.5

```

Below, following subsets of the climatologies are plotted:
- Horizontal planes at `r depth_surface_selection`m
- Meridional sections at longitudes:
  - Atlantic: `r Atl_lon`
  - Pacific: `r Pac_lon`

Section locations are indicated as white lines in the maps.

Please note that longitudes in the climatologies range from 20.5 - 379.5. For later merging with GLODAP observational data this will be projected to -179.5 - 179.5.

```{r GLODAPv2_2016_Mappedclimatologies}

#file <- file_list[1]

for (file in file_list) {
 
clim_stars <- read_stars(here::here("data/GLODAPv2_2016b_Mappedclimatologies",
                          file))

# extract parameter name

parameter <- str_split(file, pattern = "6b.", simplify = TRUE)[2]
parameter <- str_split(parameter, pattern = ".nc", simplify = TRUE)[1]

# extract parameter of interest and write csv

map_clim_stars <- clim_stars %>% select(all_of(parameter))

map_clim_stars %>% 
  as_tibble() %>% 
  rename(lat = y, lon = x, depth = depth_surface) %>% 
  mutate(lon = if_else(lon > 180, lon - 360, lon)) %>% 
  write_csv(here::here("data/GLODAPv2_2016b_MappedClimatologies/_summarized_files",
                       paste(parameter,".csv", sep = "")))

# subset depth horizons for overview map plots

map_clim_stars_horizons <- map_clim_stars %>% 
  filter(depth_surface %in% depth_surface_selection)

# plot maps

print(
ggplot() +
  geom_stars(data = map_clim_stars_horizons) +
  geom_vline(xintercept = c(Atl_lon, Pac_lon), col = "white") +
  scale_fill_viridis_b(n.breaks = 8) +
  labs(title = file) +
  facet_wrap(~depth_surface, ncol = 2) +
  coord_quickmap(expand = 0)
)

# plot sections

Atl_section <- map_clim_stars %>% 
  as_tibble() %>% 
  rename(lat = y, lon = x, depth = depth_surface, parameter = 4) %>% 
  filter(lon == Atl_lon)

Atl_section_bathy <- Atl_section %>% 
  filter(is.na(parameter)) %>% 
  group_by(lat) %>% 
  summarise(bottom_depth = min(depth)) %>% 
  ungroup()

p_Atl_section <-
ggplot() +
  geom_contour_fill(data = Atl_section,
                    aes(lat, depth, z = parameter),
                    na.fill = TRUE) +
  geom_ribbon(data = Atl_section_bathy,
              aes(x = lat, ymin = bottom_depth, ymax = 5500),
              fill = "grey80",
              col = "black") +
  labs(title = "Atlantic ocean N-S section") +
  scale_y_reverse() +
  scale_fill_viridis_b(name = parameter,
                       n.breaks = 8) +
  coord_cartesian(expand = 0)

Pac_section <- map_clim_stars %>% 
  as_tibble() %>% 
  rename(lat = y, lon = x, depth = depth_surface, parameter = 4) %>% 
  filter(lon == Pac_lon)

Pac_section_bathy <- Pac_section %>% 
  filter(is.na(parameter)) %>% 
  group_by(lat) %>% 
  summarise(bottom_depth = min(depth)) %>% 
  ungroup()

p_Pac_section <-
ggplot() +
  geom_contour_fill(data = Pac_section,
                    aes(lat, depth, z = parameter),
                    na.fill = TRUE) +
  geom_ribbon(data = Pac_section_bathy,
              aes(x = lat, ymin = bottom_depth, ymax = 5500),
              fill = "grey80",
              col = "black") +
  labs(title = "Pacific ocean N-S section") +
  scale_y_reverse() +
  scale_fill_viridis_b(name = parameter,
                       n.breaks = 8) +
  coord_cartesian(expand = 0)

print(
p_Atl_section / p_Pac_section
)

}


```

# Open tasks

- none

# Questions

- none
