---
title: "GLODAPv2_2016: Mapped Climatologies"
author: "Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r library, message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(stars)
library(metR)
library(patchwork)
```

```{r read_parameters, include = FALSE}

parameters <- read_csv(here::here("data/parameters",
                                  "parameters.csv"))

depth_levels <- read_lines(here::here("data/parameters",
                                      "depth_levels.txt"))

source(here::here("code",
                  "plotting_functions.R"))

```


```{r ggplot_theme, include = FALSE}
theme_set(theme_bw())
```



# Read source files

Data source: Globally mapped climatologies from Lauvset et al. (2016) downloaded in June 2020 from [glodap.info](https://www.glodap.info/).

Following files were used: 

```{r GLODAPv2_2016_Mappedclimatologies_file_list}

file_list <- list.files(path = "data/GLODAPv2_2016b_Mappedclimatologies", pattern = "*.nc")
print(file_list)

```


```{r read_mask_files}

basinmask <- read_csv(here::here("data/World_Ocean_Atlas_2018/_summarized_files",
                                 "basin_mask_WOA18.csv"))

landmask <- read_csv(here::here("data/World_Ocean_Atlas_2018/_summarized_files",
                                 "land_mask_WOA18.csv"))

```


# Plot data and write csv

Below, following subsets of the climatologies are plotted for all relevant parameters:  

- Horizontal planes at `r depth_levels`m
- Meridional sections at longitudes:
  - Atlantic: `r parameters$lon_Atl_section`
  - Pacific: `r parameters$lon_Pac_section`

Section locations are indicated as white lines in maps.

```{r GLODAPv2_2016_Mappedclimatologies}

file <- file_list[1]

for (file in file_list) {
 
clim <- read_stars(here::here("data/GLODAPv2_2016b_Mappedclimatologies",
                          file))

# extract parameter name

parameter <- str_split(file, pattern = "6b.", simplify = TRUE)[2]
parameter <- str_split(parameter, pattern = ".nc", simplify = TRUE)[1]

# extract parameter

clim <- clim %>% select(all_of(parameter))

#convert to table

clim_tibble <- clim %>% 
  as_tibble()

# harmonize column names

clim_tibble <- clim_tibble %>% 
  rename(lat = y,
         lon = x,
         depth = depth_surface)

# remove NAs

clim_tibble <- clim_tibble %>% 
  drop_na()

# join with basin mask and remove data outside basin mask

clim_tibble <- inner_join(clim_tibble, basinmask)

# write csv file

clim_tibble %>% 
  write_csv(here::here("data/GLODAPv2_2016b_MappedClimatologies/_summarized_files",
                       paste(parameter,".csv", sep = "")))


# plot maps

print(
map_climatology(clim_tibble, parameter)
)

# plot sections

print(
section_climatology(clim_tibble, parameter)
)

print(
section_climatology_shallow(clim_tibble, parameter)
)

}


```

# Open tasks

- none

# Questions

- none
