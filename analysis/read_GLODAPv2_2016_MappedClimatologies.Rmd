---
title: "GLODAPv2_2016: Mapped Climatologies"
author: "Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r library, message=FALSE, warning=FALSE}
library(tidyverse)
library(stars)
library(metR)
library(patchwork)
```


```{r read_parameters, include = FALSE}
parameters <-
  read_rds(here::here("data",
                       "parameters.rds"))
```

```{r read_mask_files, include = FALSE}
basinmask <-
  read_csv(
    here::here(
      "data/World_Ocean_Atlas_2018/_summarized_files",
      "basin_mask_WOA18.csv"
    )
  )
landmask <-
  read_csv(
    here::here(
      "data/World_Ocean_Atlas_2018/_summarized_files",
      "land_mask_WOA18.csv"
    )
  )
section_global_coordinates <-
  read_csv(here::here("data",
                       "section_global_coordinates.csv"))

```

```{r read_functions, include = FALSE}
source(here::here("code", "plotting_functions.R"))
```

```{r ggplot_theme, include = FALSE}
theme_set(theme_bw())
```



# Read source files

Data source: Globally mapped climatologies from Lauvset et al. (2016) downloaded in June 2020 from [glodap.info](https://www.glodap.info/).

Following files were used: 

```{r GLODAPv2_2016_Mappedclimatologies_file_list}

file_list <- list.files(path = "data/GLODAPv2_2016b_Mappedclimatologies", pattern = "*.nc")
print(file_list)

```

# Plot data and write csv

Below, subsets of the climatologies are plotted, which display for all relevant parameters:

- number of NA between surface and inventory depth
- maps at depth levels
-concentration along global section

The global section path is indicated as white line in maps.

```{r GLODAPv2_2016_Mappedclimatologies}

# file <- file_list[2]

for (file in file_list) {
 
clim <- read_stars(here::here("data/GLODAPv2_2016b_Mappedclimatologies",
                          file),
                   quiet = TRUE)

# extract parameter name

parameter <- str_split(file, pattern = "6b.", simplify = TRUE)[2]
parameter <- str_split(parameter, pattern = ".nc", simplify = TRUE)[1]
print(parameter)

# extract parameter

clim <- clim %>% select(all_of(parameter))

#convert to table

clim_tibble <- clim %>% 
  as_tibble()

# harmonize column names

clim_tibble <- clim_tibble %>% 
  rename(lat = y,
         lon = x,
         depth = depth_surface)

# join with basin mask and remove data outside basin mask

clim_tibble <- inner_join(clim_tibble, basinmask)

# plot column NA inventory

clim_tibble_grid <- clim_tibble %>%
  filter(!is.na(!!sym(parameter))) %>%
  group_by(lat, lon) %>%
  summarise(depth_max = max(depth)) %>%
  ungroup()

clim_tibble_grid <- full_join(clim_tibble, clim_tibble_grid)

clim_tibble_grid <- clim_tibble_grid %>%
  filter(depth <= depth_max) %>%
  select(-depth_max)

clim_tibble_grid <- clim_tibble_grid %>%
  filter(is.na(!!sym(parameter)),
         depth <= parameters$inventory_depth) %>%
  count(lat, lon)

# plot NA map
print(
clim_tibble_grid %>% 
  ggplot() +
    geom_raster(data = landmask,
                aes(lon, lat), fill = "grey80") +
    geom_raster(aes(lon, lat, fill = n)) +
    coord_quickmap(expand = 0) +
    scale_fill_viridis_c() +
    theme(axis.title = element_blank()) +
  labs(title = paste(parameter, "colum NA"))
)

rm(clim_tibble_grid)

# remove NAs

clim_tibble <- clim_tibble %>% 
  drop_na()

# write csv file

clim_tibble %>% 
  write_csv(here::here("data/GLODAPv2_2016b_MappedClimatologies/_summarized_files",
                       paste(parameter,".csv", sep = "")))


# plot maps

print(
map_climatology(clim_tibble, parameter)
)


# plot sections

print(
section_global(clim_tibble, parameter)
)

}


```
