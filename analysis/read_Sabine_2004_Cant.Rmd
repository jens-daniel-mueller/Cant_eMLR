---
title: "Anthropogenic CO2 from 1994 to 2007"
author: "Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r library, message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
```


```{r read_parameters, include = FALSE}
parameters <-
  read_rds(here::here("data",
                       "parameters.rds"))
```

```{r read_mask_files, include = FALSE}
basinmask <-
  read_csv(
    here::here(
      "data/World_Ocean_Atlas_2018/_summarized_files",
      "basin_mask_WOA18.csv"
    )
  )
landmask <-
  read_csv(
    here::here(
      "data/World_Ocean_Atlas_2018/_summarized_files",
      "land_mask_WOA18.csv"
    )
  )
```

```{r read_functions, include = FALSE}
source(here::here("code", "plotting_functions.R"))
```

```{r ggplot_theme, include = FALSE}
theme_set(theme_bw())
```

# Data source

- Anthropogenic CO2 estimates (1994-2007) by Gruber et al. (2019) downloaded in August 2020 from [NOAA/NCEI Ocean Carbon Data System (OCADS)](ftp://ftp.nodc.noaa.gov/pub/data.nodc/ncei/ocads/data/0001644/){target="_blank"}

# Read ncdfs

```{r read_Sabine_2004}

AnthCO2_data <- read_csv("data/GLODAPv1_1/GLODAP_gridded.data/AnthCO2.data/AnthCO2.data.txt", 
    col_names = FALSE,
    na = "-999",
    col_types = list(.default = "d"))

Depth_centers <- read_file("data/GLODAPv1_1/GLODAP_gridded.data/Depth.centers.txt")

Depth_centers <- Depth_centers %>% 
  str_split(",") %>% 
  as_vector()

Lat_centers <- read_file("data/GLODAPv1_1/GLODAP_gridded.data/Lat.centers.txt")

Lat_centers <- Lat_centers %>% 
  str_split(",") %>% 
  as_vector()

Long_centers <- read_file("data/GLODAPv1_1/GLODAP_gridded.data/Long.centers.txt")

Long_centers <- Long_centers %>% 
  str_split(",") %>% 
  as_vector()

names(AnthCO2_data) <- Lat_centers

Long_Depth <- expand_grid(depth = Depth_centers, lon = Long_centers) %>% 
  mutate(lon = as.numeric(lon),
         depth = as.numeric(depth))

Cant <- bind_cols(AnthCO2_data, Long_Depth)

Cant <- Cant %>% 
  pivot_longer(1:180, names_to = "lat", values_to = "cant") %>% 
  mutate(lat = as.numeric(lat))

Cant <- Cant %>% 
  drop_na()

Cant <- Cant %>% 
  mutate(lon = if_else(lon < 20, lon + 360, lon))

rm(AnthCO2_data, Long_Depth, Depth_centers, Lat_centers, Long_centers)

```

# Apply basin mask

```{r apply_basin_mask}

Cant <- inner_join(Cant, basinmask)

```


# Inventory calculation

```{r calculate_inventory}

source(here::here("code", "inventory_calculation.R"))

Cant <- layer_inventory(Cant, "cant")

Cant_inv <- Cant %>% 
  filter(depth <= parameters$inventory_depth) %>% 
  group_by(lon, lat, basin) %>% 
  summarise(cant_inv = sum(layer_inv_pos, na.rm = TRUE) / 1000,
            cant_inv_incl_neg = sum(layer_inv, na.rm = TRUE) / 1000) %>% 
  ungroup()

```

# Cant plots

Below, following subsets of the climatologies are plotted for all relevant parameters:  

- Horizontal planes at `r parameters$depth_levels`m
- Meridional sections at longitudes:
  - Atlantic: `r parameters$lon_Atl_section`
  - Pacific: `r parameters$lon_Pac_section`
  - Indian ocean: `r parameters$lon_Ind_section`

Section locations are indicated as white lines in maps.


## Horizontal plane maps

```{r Cant_maps, fig.asp=0.6}

map_climatology(Cant, "cant")


```

## Sections

```{r Cant_sections, fig.asp=1}

section_climatology(Cant, "cant")

```

## Sections shallow

```{r Cant_sections_shallow, fig.asp=1}

section_climatology_shallow(Cant, "cant")

```

## Inventory maps

```{r Cant_inv_pos_maps, fig.asp=0.6}

map_climatology_inv(Cant_inv, "cant_inv")

```


## Write files

```{r write_Sabine_Cant_file}

Cant %>% 
  write_csv(here::here("data/GLODAPv1_1/_summarized_files",
                       "Cant_94.csv"))

Cant_inv %>% 
  write_csv(here::here("data/GLODAPv1_1/_summarized_files",
                       "Cant_94_inv.csv"))


```



# Open tasks

- 

# Questions

- 
